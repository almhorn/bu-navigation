var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var e={},m=this;return{listenFor:function(j,d){void 0===e[j]&&(e[j]=[]);e[j].push(d);return m},broadcast:function(j,d){var b=0;if(e[j])for(b;b<e[j].length;b+=1)e[j][b].apply(this,d||[]);return m}}}();bu.hooks=function(){var e={},m=this;return{addFilter:function(j,d){void 0===e[j]&&(e[j]=[]);e[j].push(d);return m},applyFilters:function(j,d){if(void 0===e[j])return d;for(var b=Array.prototype.slice.apply(arguments).slice(1),c=0,h=d,c=0;c<e[j].length;c+=1)h=e[j][c].apply(this,
b);return h}}}()})(jQuery);
(function(e){var m=bu.plugins.navigation;m.settings={lazyLoad:!1,showCounts:!1};e(document).ready(function(){!0===e.browser.msie&&7==parseInt(e.browser.version,10)&&e(document.body).addClass("ie7");!0===e.browser.msie&&8==parseInt(e.browser.version,10)&&e(document.body).addClass("ie8");!0===e.browser.msie&&9==parseInt(e.browser.version,10)&&e(document.body).addClass("ie9")});m.tree=function(e,d){"undefined"===typeof e&&(e="base");return m.trees[e](d).initialize()};m.trees={base:function(j,d){var b=
{},d=d||{};e.extend(!0,b,bu.signals);b.config=e.extend({},m.settings,j||{});b.data={treeConfig:{},rollback:void 0};var c=b.config,h=b.data,g=b.$el=e(c.el);if(0===g.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");if(c.themePath&&document.images){var l=new Image,k=new Image;l.src=c.themePath+"/sprite.png";k.src=c.themePath+"/throbber.gif"}var l=function(a){return bu.hooks.applyFilters("canSelectNode",a)},k=function(a){return bu.hooks.applyFilters("canHoverNode",a)},
p=function(a){return bu.hooks.applyFilters("canDragNode",a)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:k,start_drag:p},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:k,start_drag:p},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:k,start_drag:p},
link:{max_children:0,max_depth:0,valid_children:"none",select_node:l,hover_node:k,start_drag:p},denied:{select_node:!1,hover_node:!1,start_drag:!1}}},json_data:{ajax:{url:c.rpcUrl,type:"POST",data:function(a){return{id:a.attr?d.stripNodePrefix(a.attr("id")):0,instance:c.instance,prefix:c.nodePrefix,post_status:c.postStatuses}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var i=d.nodeToPost(a.o),f=!0;-1===a.cr&&(!1===i.meta.excluded&&!c.allowTop)&&(f=!1);return bu.hooks.applyFilters("moveAllowed",
f,a,b)}}},bu:{lazy_load:c.lazyLoad}};c.showCounts&&(h.treeConfig.json_data.progressive_render=!1);c.initialTreeData&&(h.treeConfig.json_data.data=c.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",h.treeConfig,g);b.initialize=function(){g.jstree(h.treeConfig);return b};b.selectPost=function(a,i){var i=i||!0,f=d.getNodeForPost(a);i&&g.jstree("deselect_all");g.jstree("select_node",f)};b.getSelected=function(){var a=g.jstree("get_selected");return d.nodeToPost(a)};b.getPost=function(a){a=
d.getNodeForPost(a);return d.nodeToPost(a)};b.getPosts=function(a){var i=[],f={},c,n;(a?e.jstree._reference(g)._get_node("#"+a):g).find("> ul > li").each(function(a,h){h=e(h);c=h.attr("id");n=h.data("post_type");"new"!=n&&(c=d.stripNodePrefix(c));f={ID:c,type:n,status:h.data("post_status"),title:g.jstree("get_text",h),content:h.data("post_content"),meta:h.data("post_meta")};h.find("> ul > li").length&&(f.children=b.getPosts(h.attr("id")));i.push(f)});return i};b.showAll=function(){g.jstree("open_all")};
b.hideAll=function(){g.jstree("close_all")};b.getPostLabel=function(a){a=d.getNodeForPost(a);return g.jstree("get_text",a)};b.setPostLabel=function(a,i){var f=d.getNodeForPost(a);g.jstree("set_text",f,i)};b.insertPost=function(a,i){var f=g.jstree("get_selected"),c=0<f.length,f=e.extend({which:c?f:null,position:c?"after":"before",skip_rename:!0,callback:function(a){g.jstree("deselect_all");g.jstree("select_node",a)}},i),c=d.postToNode(a);g.jstree("create",f.which,f.position,c,f.callback,f.skip_rename);
a.ID=d.stripNodePrefix(c.attr.id);b.broadcast("insertPost",[a]);return a};b.updatePost=function(a){var i=d.getNodeForPost(a),f;i&&(f=d.nodeToPost(i),f=e.extend(!0,{},f,a),g.jstree("set_text",i,f.title),i.data("post_content",f.content),i.data("post_title",f.title),i.data("post_status",f.status),i.data("post_type",f.type),i.data("post_parent",parseInt(f.parent,10)),i.data("menu_order",parseInt(f.menu_order,10)),i.data("post_meta",f.meta));q(i);b.broadcast("updatePost",[f]);return f};b.removePost=function(a){var i;
a&&"undefined"===typeof a?(i=g.jstree("get_selected"),a=d.nodeToPost(i)):i=d.getNodeForPost(a);g.jstree("remove",i);b.broadcast("removePost",[a])};b.getAncestors=function(a){a=d.getNodeForPost(a);return g.jstree("get_path",a)};b.save=function(){h.rollback=g.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof h.rollback&&(h.rollback.d.ui.selected=e([]),e.jstree.rollback(h.rollback),h.rollback=g.jstree("get_rollback"))};d.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");
var i=a.attr("id");-1===i.indexOf("post-new")&&(i=d.stripNodePrefix(i));a={ID:i,title:g.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:parseInt(a.data("menu_order"),10),meta:a.data("post_meta")||{}};return bu.hooks.applyFilters("nodeToPost",a)};d.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var i={ID:d.getNextPostID(),title:"Untitled Post",content:"",
status:"new",type:"page",parent:0,menu_order:0,meta:{}},a=e.extend({},i,a);return bu.hooks.applyFilters("postToNode",{attr:{id:a.ID?c.nodePrefix+a.ID:"post-new-"+a.ID,rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,post_parent:a.parent,menu_order:a.menu_order,post_meta:a.meta}})};d.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID:a;-1===a.indexOf("post-new")&&(a=c.nodePrefix+
a);a=e.jstree._reference(g)._get_node("#"+a);return a.length?a:!1};d.getNextPostID=function(){return e('[id*="post-new-"]').length};d.stripNodePrefix=function(a){return a.replace(c.nodePrefix,"")};var n=function(a,i){"undefined"===typeof i&&(i=!0);var f=a.find("li").length,b=a.children("a");if(f){var d=b.children(".count");if(0===d.length){var c=b.children(".edit-options"),d=e('<span class="count"></span>');c.length?c.before(d):b.append(d)}d.text("("+f+")")}else b.children(".count").remove();i&&a.find("> ul > li").each(function(){n(e(this))})},
q=function(a){var b=a.children("a");0===b.children(".post-statuses").length&&b.append('<span class="post-statuses"></span>');var a=d.nodeToPost(a),f=a.meta.excluded||!1,e=a.meta.restricted||!1,b=b.children(".post-statuses").empty(),c=[];"publish"!=a.status&&c.push({"class":a.status,label:a.status});f&&c.push({"class":"excluded",label:"not in nav"});e&&c.push({"class":"restricted",label:"restricted"});c=bu.hooks.applyFilters("navPostStatuses",c);for(a=0;a<c.length;a++)b.append('<span class="post_status '+
c[a]["class"]+'">'+c[a].label+"</span>")};g.bind("loaded.jstree",function(){var a=g.find("> ul > li:first-child"),a=18<=a.height()?a.height():37;g.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});g.bind("reselect.jstree",function(){g.data("initial-save")||(g.data("initial-save",!0),b.save());b.broadcast("postsSelected")});g.bind("load_node.jstree",function(a,b){if(-1!==b.rslt.obj){var f=b.rslt.obj;c.showCounts&&n(f)}});g.bind("clean_node.jstree",function(a,b){var f=b.rslt.obj;f&&
-1!==f&&f.each(function(a,b){var f=e(b);0===f.find("> a > .post-statuses").length&&q(f)})});g.bind("create_node.jstree",function(a,c){var f=d.nodeToPost(c.rslt.obj);b.broadcast("postCreated",[f])});g.bind("select_node.jstree",function(a,c){var f=d.nodeToPost(c.rslt.obj);b.broadcast("selectPost",[f,b])});g.bind("deselect_node.jstree",function(a,c){var f=d.nodeToPost(c.rslt.obj);b.broadcast("deselectPost",[f,b])});g.bind("move_node.jstree",function(a,e){var f=e.rslt.np,h=e.rslt.op,j=e.rslt.o.index()+
1,l,k,m;l=g.attr("id")==f.attr("id")?0:parseInt(d.stripNodePrefix(f.attr("id")),10);"section"===h.attr("rel")&&0===h.children("ul").length&&h.attr("rel","page");"page"===f.attr("rel")&&f.attr("rel","section");c.showCounts&&(k=f.parentsUntil("#"+g.attr("id"),"li"),m=h.parentsUntil("#"+g.attr("id"),"li"),k=k.length?k.last():f,m=m.length?m.last():h,m.is("#"+k.attr("id"))||n(m),n(k));f=d.nodeToPost(e.rslt.o);f.parent=l;f.menu_order=j;b.updatePost(f);b.broadcast("postMoved",[f,l,j])});return b},navman:function(j,
d){var b={},d=d||{},b=m.trees.base(j,d),c=b.$el,h=b.data;h.treeConfig.plugins.push("contextmenu");h.treeConfig.contextmenu={show_at_node:!1,items:function(){return{edit:{label:"Edit",action:g,icon:"remove"},remove:{label:"Remove",action:l}}}};var g=function(c){c=d.nodeToPost(c);b.broadcast("editPost",[c])},l=function(c){c=d.nodeToPost(c);b.removePost(c)};c.bind("loaded.jstree",function(){c.undelegate("a","contextmenu.jstree")});c.bind("clean_node.jstree",function(b,c){var a=c.rslt.obj;a&&-1!=a&&a.each(function(a,
b){var c=e(b).children("a");if(!c.children(".edit-options").length){var d=e('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),g=c.children(".post-statuses");g.length?g.before(d):c.append(d)}})});var k=null;c.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var b=e(this).offset(),d=e(this).height()+5,a=e(this).parent("a").parent("li");c.jstree("deselect_all");e(this).addClass("clicked");c.jstree("select_node",a);c.jstree("show_contextmenu",
a,b.left,b.top+d);k&&k.attr("id")!=a.attr("id")&&p(k);k=a});e(document).bind("context_hide.vakata",function(){p(k)});var p=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};e(document).bind("click",function(b){var d=e.contains(c[0],b.target),b=e.contains(e("#vakata-contextmenu")[0],b.target);!d&&!b&&c.jstree("deselect_all")});return b},edit_post:function(j,d){var d=d||{},b=m.trees.base(j,d),c=b.data,h=e.extend(b.config,j||{}),g=b.$el,l=h.currentPost,k=h.nodePrefix+l,p={},n=[],q=
[],a;if(l&&(n.push("#"+k),h.ancestors&&h.ancestors.length)){var i=h.ancestors.reverse();for(a=0;a<i.length;a++)q.push("#"+h.nodePrefix+h.ancestors[a])}n.length&&(p.ui={initially_select:n});q.length&&(p.core={initially_open:q});e.extend(!0,c.treeConfig,p);c=function(a){return d.stripNodePrefix(a.attr("id"))==l};bu.hooks.addFilter("canSelectNode",c);bu.hooks.addFilter("canHoverNode",c);bu.hooks.addFilter("canDragNode",c);b.getCurrentPost=function(){if(null===l||"undefined"===typeof l)return!1;var a=
d.getNodeForPost(l);return d.nodeToPost(a)};b.setCurrentPost=function(a){var c=d.getNodeForPost(a);l=a.ID;k=c.attr("id");b.selectPost(a)};b.scrollToSelection=function(){var a=g.jstree("get_selected");if(a.length){e(document);g.css("overflow");var b=g.innerHeight(),a=a.position().top+a.height()/2-b/2;0<a&&g.scrollTop(a)}};return b}}})(jQuery);