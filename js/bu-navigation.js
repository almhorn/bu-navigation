var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(e){var p={listenFor:function(c,b){var f=this._listeners;void 0===f[c]&&(f[c]=[]);f[c].push(b)},broadcast:function(c,b){var f,e=this._listeners;if(e[c])for(f=0;f<e[c].length;f+=1)e[c][f].apply(this,b||[])}};bu.signals={register:function(c){c._listeners={};e.extend(!0,c,p)}};var k={};bu.hooks={addFilter:function(c,b){void 0===k[c]&&(k[c]=[]);k[c].push(b);return this},applyFilters:function(c,b){if(void 0===k[c])return b;var e=Array.prototype.slice.apply(arguments).slice(1),h=b,d;for(d=0;d<
k[c].length;d+=1)h=k[c][d].apply(this,e);return h}}})(jQuery);
(function(e){var p=bu.plugins.navigation;p.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0};e(document).ready(function(){!0===e.browser.msie&&7==parseInt(e.browser.version,10)&&e(document.body).addClass("ie7");!0===e.browser.msie&&8==parseInt(e.browser.version,10)&&e(document.body).addClass("ie8");!0===e.browser.msie&&9==parseInt(e.browser.version,10)&&e(document.body).addClass("ie9")});p.tree=function(e,c){"undefined"===typeof e&&(e="base");return p.trees[e](c).initialize()};
p.trees={base:function(k,c){var b={},c=c||{};bu.signals.register(b);b.config=e.extend({},p.settings,k||{});b.data={treeConfig:{},rollback:void 0};var f=b.config,h=b.data,d=b.$el=e(f.el);if(f.themePath&&document.images){var j=new Image,n=new Image;j.src=f.themePath+"/sprite.png";n.src=f.themePath+"/throbber.gif"}var j=function(a){return bu.hooks.applyFilters("canSelectNode",a,b)},n=function(a){return bu.hooks.applyFilters("canHoverNode",a,b)},l=function(a){return bu.hooks.applyFilters("canDragNode",
a,b)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},dnd:{drag_container:document},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:n,start_drag:l},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:n,start_drag:l},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:n,
start_drag:l},link:{max_children:0,max_depth:0,valid_children:"none",select_node:j,hover_node:n,start_drag:l}}},json_data:{ajax:{url:f.rpcUrl,type:"POST",data:function(a){return{child_of:(-1===a?{ID:0}:c.nodeToPost(a)).ID,post_types:f.postTypes,post_statuses:f.postStatuses,instance:f.instance,prefix:f.nodePrefix}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var m=c.nodeToPost(a.o),g,e=!0;g=!1===m.post_meta.excluded||"link"===m.post_type;var i=!m.originalExclude&&
(0===m.originalParent||"new"===m.post_status&&"link"!==m.post_type);-1===a.cr&&(!i&&g&&!f.allowTop)&&(e=!1);a.np.length&&a.np.attr("id")!==d.attr("id")&&(g=c.nodeToPost(a.np),"publish"==m.post_status&&"publish"!=g.post_status&&(e=!1));return bu.hooks.applyFilters("moveAllowed",e,a,b)}}},bu:{lazy_load:f.lazyLoad}};f.showCounts&&(h.treeConfig.json_data.progressive_render=!1);f.initialTreeData&&(h.treeConfig.json_data.data=f.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",h.treeConfig,
d);b.initialize=function(){d.jstree(h.treeConfig);return b};b.openPost=function(a){if(a=c.getNodeForPost(a))d.jstree("open_node",a,e.noop,!0);else return!1};b.selectPost=function(a,b){var b=b||!0,g=c.getNodeForPost(a);b&&d.jstree("deselect_all");d.jstree("select_node",g)};b.getSelectedPost=function(){var a=d.jstree("get_selected");return a.length?c.nodeToPost(a):!1};b.deselectAll=function(){d.jstree("deselect_all")};b.getPost=function(a){return(a=c.getNodeForPost(a))?c.nodeToPost(a):!1};b.getPosts=
function(a){var m=[],g={};(a?e.jstree._reference(d)._get_node("#"+a):d).find("> ul > li").each(function(a,d){d=e(d);g=c.nodeToPost(d);d.find("> ul > li").length&&(g.children=b.getPosts(d.attr("id")));m.push(g)});return m};b.showAll=function(){d.jstree("open_all")};b.hideAll=function(){d.jstree("close_all")};b.getPostLabel=function(a){a=c.getNodeForPost(a);return d.jstree("get_text",a)};b.setPostLabel=function(a,b){var g=c.getNodeForPost(a);d.jstree("set_text",g,b)};b.insertPost=function(a,m){var g,
e,i;if("undefined"===typeof a)throw new TypeError("Post argument for insertPost must be defined!");var f,r;a.post_parent=a.post_parent||0;a.menu_order=a.menu_order||1;a.post_parent?(g=c.getNodeForPost(a.post_parent),f=b.getPost(a.post_parent)):g=d;1==a.menu_order?(i=g.find("> ul > li").get(0),e="before"):(r=a.menu_order-2,0<=r&&(i=g.find("> ul > li").get(r),e="after"));i||(i=g,e="inside");g=i;i=m||function(a){d.jstree("deselect_all");d.jstree("select_node",a)};a=bu.hooks.applyFilters("preInsertPost",
a,f);f=c.postToNode(a);f=d.jstree("create_node",g,e,f,i);a.ID||(a.ID=f.attr("id"));return a};b.updatePost=function(a){var m=c.getNodeForPost(a),g;return m?(g=c.nodeToPost(m),a=e.extend(!0,{},g,a),d.jstree("set_text",m,a.post_title),a.post_parent=parseInt(a.post_parent,10),a.menu_order=parseInt(a.menu_order,10),m.data("post",a),f.showStatuses&&m.find("li").andSelf().each(function(){i(e(this))}),b.broadcast("postUpdated",[a]),a):!1};b.removePost=function(a){a&&"undefined"===typeof a?(a=d.jstree("get_selected"),
c.nodeToPost(a)):a=c.getNodeForPost(a);d.jstree("remove",a)};b.getAncestors=function(a){a=c.getNodeForPost(a);return d.jstree("get_path",a)};b.save=function(){h.rollback=d.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof h.rollback&&(h.rollback.d.ui.selected=e([]),e.jstree.rollback(h.rollback),h.rollback=d.jstree("get_rollback"))};b.lock=function(){d.jstree("lock")};b.unlock=function(){d.jstree("unlock")};c.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");
var b,g;b=a.attr("id");g=e.extend({},!0,a.data("post"));-1===b.indexOf("post-new")&&(b=parseInt(c.stripNodePrefix(b),10));g.ID=b;g.post_title=d.jstree("get_text",a);g.menu_order=a.index()+1;g.post_parent=parseInt(g.post_parent,10);g.originalParent=parseInt(g.originalParent,10);g.originalOrder=parseInt(g.originalOrder,10);g.inheritedRestriction=a.data("inheritedRestriction")||!1;g.post_meta=g.post_meta||{};return bu.hooks.applyFilters("nodeToPost",g,a)};c.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");
var b,a=e.extend({},{post_title:"(no title)",post_content:"",post_status:"new",post_type:"page",post_parent:0,menu_order:1,post_meta:{},url:""},a);b=a.ID?f.nodePrefix+a.ID:"post-new-"+c.getNextPostID();return bu.hooks.applyFilters("postToNode",{attr:{id:b,rel:a.post_type},data:{title:a.post_title},metadata:{post:a}},a)};c.getNodeForPost=function(a){if("undefined"===typeof a)return!1;a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=f.nodePrefix+a);a=e.jstree._reference(d)._get_node("#"+
a);return a.length?a:!1};c.getNextPostID=function(){return e('[id*="post-new-"]').length};c.stripNodePrefix=function(a){return a.replace(f.nodePrefix,"")};var q=function(a,b){var g=a.find("li").length,c=a.children("a");0===c.children(".title-count").children(".count").length&&c.children(".title-count").append('<span class="count"></span>');c=c.find("> .title-count > .count").empty();g?c.text("("+g+")"):c.text("");b&&a.find("li").each(function(){q(e(this))})},i=function(a){var b=a.children("a");0===
b.children(".post-statuses").length&&b.append('<span class="post-statuses"></span>');var g=c.nodeToPost(a),i,f,r;c.nodeToPost(a);a.parentsUntil("#"+d.attr("id"),"li").filter(function(){return e(this).data("post").post_meta.restricted||e(this).data("inheritedRestriction")}).length?a.data("inheritedRestriction",!0):a.data("inheritedRestriction",!1);i=g.post_meta.excluded||!1;f=g.post_meta.restricted||a.data("inheritedRestriction")||!1;r=g.post_meta["protected"]||!1;b=b.children(".post-statuses").empty();
a=[];"publish"!=g.post_status&&a.push({"class":g.post_status,label:g.post_status});i&&a.push({"class":"excluded",label:"not in nav"});f&&a.push({"class":"restricted",label:"restricted"});r&&a.push({"class":"protected",label:"protected"});for(g=0;g<a.length;g+=1)b.append('<span class="post_status '+a[g]["class"]+'">'+a[g].label+"</span>")},r=function(a){0===a.children("ul").length?a.attr("rel","page"):a.attr("rel","section");f.showCounts&&(a=a.parent("ul").parent("div").attr("id")!=d.attr("id")?a.parents("li:last"):
a,q(a,!0))};d.bind("loaded.jstree",function(){var a=d.find("> ul > li:first-child"),a=18<=a.height()?a.height():32;d.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});d.bind("reselect.jstree",function(){b.broadcast("postsSelected")});d.bind("lazy_loaded.jstree",function(){b.broadcast("lazyLoadComplete")});d.bind("load_node.jstree",function(a,b){if(-1!==b.rslt.obj){var c=b.rslt.obj;f.showCounts&&q(c,!0)}});d.bind("clean_node.jstree",function(a,b){var c=b.rslt.obj;c&&-1!==c&&c.each(function(a,
b){var c=e(b);c.data("buNavExtrasAdded")||(f.showStatuses&&i(c),c.data("buNavExtrasAdded",!0))})});d.bind("before.jstree",function(a,b){var c;switch(b.func){case "select_node":case "hover_node":case "start_drag":if((c=b.inst._get_node(b.args[0]))&&c.hasClass("denied"))return!1}});d.bind("create_node.jstree",function(a,d){var g=c.nodeToPost(d.rslt.obj);b.broadcast("postCreated",[g])});d.bind("select_node.jstree",function(a,d){var g=c.nodeToPost(d.rslt.obj);b.broadcast("postSelected",[g])});d.bind("create.jstree",
function(a,d){var g=d.rslt.parent,e=d.rslt.position,i=c.nodeToPost(d.rslt.obj),f=null;-1!==g&&(f=c.nodeToPost(g),r(g));i.post_parent=f?f.ID:0;i.menu_order=e+1;b.broadcast("postInserted",[i])});d.bind("remove.jstree",function(a,d){var g=d.rslt.obj,i=c.nodeToPost(g),f=d.rslt.parent,h;-1!==f&&r(f);b.broadcast("postRemoved",[i]);g.find("li").each(function(){(h=c.nodeToPost(e(this)))&&b.broadcast("postRemoved",[h])})});d.bind("deselect_node.jstree",function(a,d){var g=c.nodeToPost(d.rslt.obj);b.broadcast("postDeselected",
[g])});d.bind("deselect_all.jstree",function(){b.broadcast("postsDeselected")});d.bind("move_node.jstree",function(a,i){i.rslt.o.each(function(a,f){var h=e(f),j=c.nodeToPost(h),k=i.rslt.np,l=i.rslt.op,h=h.index()+1,n=0,p=0,q=1;d.attr("id")!==k.attr("id")&&(r(k),n=parseInt(c.stripNodePrefix(k.attr("id")),10));d.attr("id")!==l.attr("id")&&!k.is("#"+l.attr("id"))&&(r(l),k=c.nodeToPost(l),p=k.ID);q=j.menu_order;j.post_parent=n;j.menu_order=h;b.updatePost(j);b.broadcast("postMoved",[j,p,q])})});j=function(a){if("undefined"!==
typeof d[0]){var b=e.contains(d[0],a.target),a=e.contains(e("#vakata-contextmenu")[0],a.target);!b&&!a&&d.jstree("deselect_all")}};f.deselectOnDocumentClick&&e(document).bind("click",j);return b},navman:function(k,c){var b={},c=c||{},b=p.trees.base(k,c),f=b.$el,h=b.data,d=function(d){d=c.nodeToPost(d);b.broadcast("editPost",[d])},j=function(b){b=c.nodeToPost(b);b.url&&window.open(b.url)},n=function(d){d=c.nodeToPost(d);b.removePost(d)};h.treeConfig.plugins.push("contextmenu");h.treeConfig.contextmenu=
{show_at_node:!1,items:function(b){var e=c.nodeToPost(b),a={edit:{label:"Edit",action:d},view:{label:"View",action:j},remove:{label:"Move to Trash",action:n}};e.url||delete a.view;"link"===e.post_type&&(a.remove.label="Delete");return bu.hooks.applyFilters("navmanOptionsMenuItems",a,b)}};f.bind("loaded.jstree",function(){f.undelegate("a","contextmenu.jstree")});f.bind("clean_node.jstree",function(b,c){var a=c.rslt.obj;a&&-1!=a&&a.each(function(a,b){var c=e(b).children("a");if(!c.children(".edit-options").length){var d=
e('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),f=c.children(".post-statuses");f.length?f.before(d):c.append(d)}})});var l=null;f.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var c,a,d;c=e(this).offset();a=e(this).outerWidth();d=e(this).outerHeight();b=c.top;c=c.left;b+=d;c=c+a-180;a=e(this).closest("li");f.jstree("deselect_all");f.jstree("select_node",a);f.jstree("show_contextmenu",a,c,b);e(this).addClass("clicked");l&&
l.attr("id")!=a.attr("id")&&q(l);l=a});e(document).bind("context_hide.vakata",function(){q(l)});var q=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};f.addClass("bu-navman");return b},edit_post:function(k,c){var c=c||{},b=p.trees.base(k,c),f=b.data,h=e.extend(b.config,k||{}),d=b.$el,j=h.currentPost,n={};n.dnd={drag_container:h.treeDragContainer};e.extend(!0,f.treeConfig,n);f=function(d,e){if(e.$el.is(b.$el.selector))return c.stripNodePrefix(d.attr("id"))==j.ID};bu.hooks.addFilter("canSelectNode",
f);bu.hooks.addFilter("canHoverNode",f);bu.hooks.addFilter("canDragNode",f);d.bind("loaded.jstree",function(){var b;if(h.ancestors&&h.ancestors.length){b=h.ancestors.reverse();var e=c.getNodeForPost(b[0].ID);e?(b.shift(),d.jstree("open_node",e,function(){l(b)},!0)):l(b)}else q()});var l=function(c){var c=c||[],d,a;for(a=0;a<c.length;a+=1)d=h.ancestors[a],!1===b.openPost(d.ID)&&(b.insertPost(d),b.openPost(d.ID));q()},q=function(){c.getNodeForPost(j)?(b.selectPost(j),b.save()):b.insertPost(j,function(){b.selectPost(j);
b.save()})};b.getCurrentPost=function(){var b;return(b=c.getNodeForPost(j))?b=c.nodeToPost(b):!1};b.setCurrentPost=function(b){j=b};d.addClass("bu-edit-post");return b}}})(jQuery);