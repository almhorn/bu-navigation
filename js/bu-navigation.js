var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var f={},n=this;return{listenFor:function(j,d){void 0===f[j]&&(f[j]=[]);f[j].push(d);return n},broadcast:function(j,d){var b=0;if(f[j])for(b;b<f[j].length;b+=1)f[j][b].apply(this,d||[]);return n}}}();bu.hooks=function(){var f={},n=this;return{addFilter:function(j,d){void 0===f[j]&&(f[j]=[]);f[j].push(d);return n},applyFilters:function(j,d){if(void 0===f[j])return d;for(var b=Array.prototype.slice.apply(arguments).slice(1),g=0,h=d,g=0;g<f[j].length;g+=1)h=f[j][g].apply(this,
b);return h}}}()})(jQuery);
(function(f){var n=bu.plugins.navigation;n.settings={lazyLoad:!1,showCounts:!1};f(document).ready(function(){!0===f.browser.msie&&7==parseInt(f.browser.version,10)&&f(document.body).addClass("ie7");!0===f.browser.msie&&8==parseInt(f.browser.version,10)&&f(document.body).addClass("ie8");!0===f.browser.msie&&9==parseInt(f.browser.version,10)&&f(document.body).addClass("ie9")});n.tree=function(f,d){"undefined"===typeof f&&(f="base");return n.trees[f](d).initialize()};n.trees={base:function(j,d){var b=
{},d=d||{};f.extend(!0,b,bu.signals);b.config=f.extend({},n.settings,j||{});b.data={treeConfig:{},rollback:void 0};var g=b.config,h=b.data,c=b.$el=f(g.el);if(0===c.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");if(g.themePath&&document.images){var k=new Image,l=new Image;k.src=g.themePath+"/sprite.png";l.src=g.themePath+"/throbber.gif"}var k=function(a){return bu.hooks.applyFilters("canSelectNode",a)},l=function(a){return bu.hooks.applyFilters("canHoverNode",a)},
p=function(a){return bu.hooks.applyFilters("canDragNode",a)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:l,start_drag:p},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:l,start_drag:p},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:l,start_drag:p},
link:{max_children:0,max_depth:0,valid_children:"none",select_node:k,hover_node:l,start_drag:p},denied:{select_node:!1,hover_node:!1,start_drag:!1}}},json_data:{ajax:{url:g.rpcUrl,type:"POST",data:function(a){return{id:a.attr?d.stripNodePrefix(a.attr("id")):0,instance:g.instance,prefix:g.nodePrefix,post_status:g.postStatuses}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var e=d.nodeToPost(a.o),i=!0;-1===a.cr&&(!1===e.meta.excluded&&!g.allowTop)&&(i=!1);return bu.hooks.applyFilters("moveAllowed",
i,a,b)}}},bu:{lazy_load:g.lazyLoad}};g.showCounts&&(h.treeConfig.json_data.progressive_render=!1);g.initialTreeData&&(h.treeConfig.json_data.data=g.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",h.treeConfig,c);b.initialize=function(){c.jstree(h.treeConfig);return b};b.selectPost=function(a,e){var e=e||!0,i=d.getNodeForPost(a);e&&c.jstree("deselect_all");c.jstree("select_node",i)};b.getSelected=function(){var a=c.jstree("get_selected");return d.nodeToPost(a)};b.getPost=function(a){a=
d.getNodeForPost(a);return d.nodeToPost(a)};b.getPosts=function(a){var e=[],i={},g,m;(a?f.jstree._reference(c)._get_node("#"+a):c).find("> ul > li").each(function(a,h){h=f(h);g=h.attr("id");m=h.data("post_type");"new"!=m&&(g=d.stripNodePrefix(g));i={ID:g,type:m,status:h.data("post_status"),title:c.jstree("get_text",h),content:h.data("post_content"),meta:h.data("post_meta")};h.find("> ul > li").length&&(i.children=b.getPosts(h.attr("id")));e.push(i)});return e};b.showAll=function(){c.jstree("open_all")};
b.hideAll=function(){c.jstree("close_all")};b.getPostLabel=function(a){a=d.getNodeForPost(a);return c.jstree("get_text",a)};b.setPostLabel=function(a,e){var i=d.getNodeForPost(a);c.jstree("set_text",i,e)};b.insertPost=function(a,e){var i=c.jstree("get_selected"),b=0<i.length,i=f.extend({which:b?i:null,position:b?"after":"before",skip_rename:!0,callback:function(a){c.jstree("deselect_all");c.jstree("select_node",a)}},e),b=d.postToNode(a);c.jstree("create",i.which,i.position,b,i.callback,i.skip_rename);
return a};b.updatePost=function(a){var e=d.getNodeForPost(a),i;e&&(i=d.nodeToPost(e),i=f.extend(!0,{},i,a),c.jstree("set_text",e,i.title),e.data("post_content",i.content),e.data("post_title",i.title),e.data("post_status",i.status),e.data("post_type",i.type),e.data("post_parent",parseInt(i.parent,10)),e.data("menu_order",parseInt(i.menu_order,10)),e.data("post_meta",i.meta));r(e);b.broadcast("updatePost",[i]);return i};b.removePost=function(a){a&&"undefined"===typeof a?(a=c.jstree("get_selected"),
d.nodeToPost(a)):a=d.getNodeForPost(a);c.jstree("remove",a)};b.getAncestors=function(a){a=d.getNodeForPost(a);return c.jstree("get_path",a)};b.save=function(){h.rollback=c.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof h.rollback&&(h.rollback.d.ui.selected=f([]),f.jstree.rollback(h.rollback),h.rollback=c.jstree("get_rollback"))};d.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var e=a.attr("id");-1===e.indexOf("post-new")&&(e=parseInt(d.stripNodePrefix(e),
10));a={ID:e,title:c.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:parseInt(a.data("menu_order"),10),meta:a.data("post_meta")||{}};return bu.hooks.applyFilters("nodeToPost",a)};d.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var e={ID:d.getNextPostID(),title:"Untitled Post",content:"",status:"new",type:"page",parent:0,menu_order:0,meta:{}},a=f.extend({},
e,a);return bu.hooks.applyFilters("postToNode",{attr:{id:a.ID?g.nodePrefix+a.ID:"post-new-"+a.ID,rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,post_parent:a.parent,menu_order:a.menu_order,post_meta:a.meta}})};d.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=g.nodePrefix+a);a=f.jstree._reference(c)._get_node("#"+a);
return a.length?a:!1};d.getNextPostID=function(){return f('[id*="post-new-"]').length};d.stripNodePrefix=function(a){return a.replace(g.nodePrefix,"")};var m=function(a,e){"undefined"===typeof e&&(e=!0);var i=a.find("li").length,b=a.children("a");if(i){var d=b.children(".count");if(0===d.length){var c=b.children(".edit-options"),d=f('<span class="count"></span>');c.length?c.before(d):b.append(d)}d.text("("+i+")")}else b.children(".count").remove();e&&a.find("> ul > li").each(function(){m(f(this))})},
r=function(a){var e=a.children("a");0===e.children(".post-statuses").length&&e.append('<span class="post-statuses"></span>');var a=d.nodeToPost(a),b=a.meta.excluded||!1,f=a.meta.restricted||!1,e=e.children(".post-statuses").empty(),c=[];"publish"!=a.status&&c.push({"class":a.status,label:a.status});b&&c.push({"class":"excluded",label:"not in nav"});f&&c.push({"class":"restricted",label:"restricted"});c=bu.hooks.applyFilters("navPostStatuses",c);for(a=0;a<c.length;a++)e.append('<span class="post_status '+
c[a]["class"]+'">'+c[a].label+"</span>")},q=function(a){var e;0===a.children("ul").length?a.attr("rel","page"):a.attr("rel","section");g.showCounts&&(e=a.parentsUntil("#"+c.attr("id"),"li"),e=e.length?e.last():a,m(e))};c.bind("loaded.jstree",function(){var a=c.find("> ul > li:first-child"),a=18<=a.height()?a.height():37;c.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});c.bind("reselect.jstree",function(){c.data("initial-save")||(c.data("initial-save",!0),b.save());b.broadcast("postsSelected")});
c.bind("load_node.jstree",function(a,e){if(-1!==e.rslt.obj){var b=e.rslt.obj;g.showCounts&&m(b)}});c.bind("clean_node.jstree",function(a,e){var b=e.rslt.obj;b&&-1!==b&&b.each(function(a,e){var b=f(e);0===b.find("> a > .post-statuses").length&&r(b)})});c.bind("create_node.jstree",function(a,e){var c=d.nodeToPost(e.rslt.obj);b.broadcast("postCreated",[c])});c.bind("select_node.jstree",function(a,e){var c=d.nodeToPost(e.rslt.obj);b.broadcast("selectPost",[c,b])});c.bind("create.jstree",function(a,e){var c=
e.rslt.parent,f=e.rslt.position;post=d.nodeToPost(e.rslt.obj);postParent=null;-1!==c&&(postParent=d.nodeToPost(c),q(c));post.parent=postParent?postParent.ID:0;post.menu_order=f+1;b.broadcast("insertPost",[post])});c.bind("remove.jstree",function(a,e){var c=d.nodeToPost(e.rslt.obj),f=e.rslt.parent;-1!==f&&q(f);b.broadcast("removePost",[c])});c.bind("deselect_node.jstree",function(a,e){var c=d.nodeToPost(e.rslt.obj);b.broadcast("deselectPost",[c,b])});c.bind("move_node.jstree",function(a,e){var f=d.nodeToPost(e.rslt.o),
g=e.rslt.np,h=e.rslt.op,m=e.rslt.o.index()+1,j=0;c.attr("id")!==g.attr("id")&&(q(g),j=parseInt(d.stripNodePrefix(g.attr("id")),10));c.attr("id")!==h.attr("id")&&!g.is("#"+h.attr("id"))&&q(h);f.parent=j;f.menu_order=m;b.updatePost(f);b.broadcast("postMoved",[f,j,m])});return b},navman:function(j,d){var b={},d=d||{},b=n.trees.base(j,d),g=b.$el,h=b.data;h.treeConfig.plugins.push("contextmenu");h.treeConfig.contextmenu={show_at_node:!1,items:function(){return{edit:{label:"Edit",action:c,icon:"remove"},
remove:{label:"Remove",action:k}}}};var c=function(c){c=d.nodeToPost(c);b.broadcast("editPost",[c])},k=function(c){c=d.nodeToPost(c);b.removePost(c)};g.bind("loaded.jstree",function(){g.undelegate("a","contextmenu.jstree")});g.bind("clean_node.jstree",function(b,c){var d=c.rslt.obj;d&&-1!=d&&d.each(function(a,e){var b=f(e).children("a");if(!b.children(".edit-options").length){var c=f('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),d=b.children(".post-statuses");
d.length?d.before(c):b.append(c)}})});var l=null;g.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var b=f(this).offset(),c=f(this).height()+5,d=f(this).parent("a").parent("li");g.jstree("deselect_all");f(this).addClass("clicked");g.jstree("select_node",d);g.jstree("show_contextmenu",d,b.left,b.top+c);l&&l.attr("id")!=d.attr("id")&&p(l);l=d});f(document).bind("context_hide.vakata",function(){p(l)});var p=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};
f(document).bind("click",function(b){var c=f.contains(g[0],b.target),b=f.contains(f("#vakata-contextmenu")[0],b.target);!c&&!b&&g.jstree("deselect_all")});return b},edit_post:function(j,d){var d=d||{},b=n.trees.base(j,d),g=b.data,h=f.extend(b.config,j||{}),c=b.$el,k=h.currentPost,l=h.nodePrefix+k,p={},m=[],r=[],q;if(k&&(m.push("#"+l),h.ancestors&&h.ancestors.length)){var a=h.ancestors.reverse();for(q=0;q<a.length;q++)r.push("#"+h.nodePrefix+h.ancestors[q])}m.length&&(p.ui={initially_select:m});r.length&&
(p.core={initially_open:r});f.extend(!0,g.treeConfig,p);g=function(a){return d.stripNodePrefix(a.attr("id"))==k};bu.hooks.addFilter("canSelectNode",g);bu.hooks.addFilter("canHoverNode",g);bu.hooks.addFilter("canDragNode",g);b.getCurrentPost=function(){if(null===k||"undefined"===typeof k)return!1;var a=d.getNodeForPost(k);return d.nodeToPost(a)};b.setCurrentPost=function(a){var c=d.getNodeForPost(a);k=a.ID;l=c.attr("id");b.selectPost(a)};b.scrollToSelection=function(){var a=c.jstree("get_selected");
if(a.length){f(document);c.css("overflow");var b=c.innerHeight(),a=a.position().top+a.height()/2-b/2;0<a&&c.scrollTop(a)}};return b}}})(jQuery);