var bu=bu||{};bu.navigation={};(function(){var d=bu.navigation;d.settings=buNavSettings||{};d.settings.initialTreeData&&"string"===typeof d.settings.initialTreeData&&(d.settings.initialTreeData=JSON.parse(d.settings.initialTreeData))})(jQuery);
(function(d){var k=bu.navigation;k.tree=function(d,e){if("undefined"===typeof d)throw new TypeError("Invalid navigation tree type!");return k.trees[d](e).initialize()};k.trees={base:function(m,e){var b={},e=e||{};b.config=d.extend({},{el:"#navman_container",nodePrefix:"p"},m||{});b.data={treeConfig:{},rollback:void 0};var f=k.settings,j=b.config,h=b.data,i={};b.listenFor=function(a,g){"undefined"===typeof i[a]&&(i[a]=[]);i[a].push(g);return b};b.broadcast=function(a,g){var e;if(i[a])for(e=0;e<i[a].length;e++)i[a][e].apply(b,
g)};var c=b.$el=d(j.el);if(0===c.length)return!1;h.treeConfig={themes:{theme:"classic"},core:{animation:0,html_titles:!0},plugins:"themes json_data ui types dnd crrm".split(" "),types:{types:{"default":{clickable:!0,renameable:!0,deletable:!0,creatable:!0,draggable:!0,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_regular.png"}},page:{clickable:!0,renameable:!1,deletable:!0,creatable:!0,draggable:!0,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+
"/icons/page_regular.png"}},page_excluded:{clickable:!0,renameable:!1,deletable:!0,creatable:!0,draggable:!0,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_hidden.png"}},page_restricted:{clickable:!0,renameable:!1,deletable:!0,creatable:!0,draggable:!0,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_restricted.png"}},page_denied:{clickable:!1,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,
max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_regular.png"}},page_excluded_denied:{clickable:!1,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_hidden.png"}},page_restricted_denied:{clickable:!1,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_restricted.png"}},page_excluded_restricted:{clickable:!0,
renameable:!1,deletable:!0,creatable:!0,draggable:!0,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_hidden_restricted.png"}},page_excluded_restricted_denied:{clickable:!1,renameable:!1,deletable:!1,creatable:!1,draggable:!1,max_children:-1,max_depth:-1,valid_children:"all",icon:{image:f.interfacePath+"/icons/page_hidden_restricted.png"}},link:{icon:{image:f.interfacePath+"/icons/page_white_link.png"},max_children:0},link_restricted:{icon:{image:f.interfacePath+
"/icons/page_white_link.png"},max_children:0},link_excluded:{icon:{image:f.interfacePath+"/icons/page_white_link.png"},max_children:0}}},json_data:{data:f.initialTreeData,ajax:{url:f.rpcUrl,type:"POST",data:function(a){return{id:a.attr?a.attr("id"):0}}},progressive_render:!0}};b.initialize=function(){c.jstree(h.treeConfig);return b};b.selectPost=function(a){a=e.getNodeForPost(a);c.jstree("select_node",a)};b.getSelected=function(){var a=c.jstree("get_selected");return e.nodeToPost(a)};b.getPosts=function(){return c.jstree("get_json",
-1)};b.showAll=function(){c.jstree("open_all")};b.hideAll=function(){c.jstree("close_all")};b.insertPost=function(a,g){var l=d.extend({position:"after",which:null,skip_rename:!0,callback:null},g),f=e.postToNode(a);c.jstree("create",l.which,l.position,f,l.callback,l.skip_rename);b.broadcast("insertPost",[a]);return f.attr.id};b.updatePost=function(a){var g=e.getNodeForPost(a);g&&(c.jstree("set_text",g,a.title),g.data("post_content",a.content),g.data("post_title",a.title),g.data("post_status",a.status),
g.data("post_type",a.type),g.data("post_parent",a.parent),g.data("menu_order",a.menu_order),g.data("post_meta",a.meta));b.broadcast("updatePost",[a])};b.removePost=function(a){var g;a&&"undefined"===typeof a?(g=c.jstree("get_selected"),a=e.nodeToPost(g)):g=e.getNodeForPost(a);c.jstree("remove",g);b.broadcast("removePost",[a])};b.getAncestors=function(a){var b=[];e.getNodeForPost(a).parentsUntil(c,"li").each(function(){b.push(e.nodeToPost(d(this)))});return b};b.save=function(){h.rollback=c.jstree("get_rollback")};
b.restore=function(){h.rollback.d.ui.selected=d([]);d.jstree.rollback(h.rollback)};e.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node argument!");var b=a.attr("id");-1===b.indexOf("post-new")&&(b=e.stripNodePrefix(b));return{ID:b,title:c.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:a.data("post_parent"),menu_order:a.data("menu_order"),meta:a.data("post_meta")||{}}};e.postToNode=function(a,b){if("undefined"===
typeof a)throw new TypeError("Invalid post argument!");d.extend({},{hasChildren:!1,parentId:0},b||{});var c={ID:e.getNextPostID(),title:"Untitled Post",content:"",status:"new",type:"page",parent:0,menu_order:0,meta:{}},c=d.extend({},c,a);return{attr:{id:c.ID?j.nodePrefix+c.ID:"post-new-"+c.ID,rel:c.type},data:{title:c.title},metadata:{post_status:c.status,post_type:c.type,post_content:c.content,post_meta:c.meta}}};e.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post argument!");
a=a&&"object"===typeof a?a.ID:a;-1===a.indexOf("post-new")&&(a=j.nodePrefix+a);a=d.jstree._reference(c)._get_node("#"+a);return a.length?a:!1};e.getNextPostID=function(){return d('[id*="post-new-"]').length};e.appendPostStatus=function(a){var b=a.data("post_status")||"publish";"publish"!=b&&a.children("a").after('<span class="post_status '+b+'">'+b+"</span>")};e.stripNodePrefix=function(a){return a.replace(j.nodePrefix,"")};c.bind("loaded.jstree",function(){b.broadcast("postsLoaded")});c.bind("reselect.jstree",
function(){b.broadcast("postsSelected")});c.bind("clean_node.jstree",function(a,b){var c=b.rslt.obj;c&&-1!=c&&c.each(function(a,b){var c=d(b);c.data("meta-loaded")||(e.appendPostStatus(c),c.data("meta-loaded",!0))})});c.bind("create_node.jstree",function(a,c){var d=e.nodeToPost(c.rslt.obj);b.broadcast("postCreated",[d])});c.bind("select_node.jstree",function(a,c){var d=e.nodeToPost(c.rslt.obj);b.broadcast("selectPost",[d])});c.bind("deselect_node.jstree",function(a,c){var d=e.nodeToPost(c.rslt.obj);
b.broadcast("deselectPost",[d])});return b},navman:function(d,e){var b={},e=e||{},b=k.trees.base(d,e),f=b.data;f.treeConfig.plugins.push("contextmenu");f.treeConfig.contextmenu={items:function(){return{edit:{label:"Edit",action:j,icon:"remove"},remove:{label:"Remove",action:h}}}};var j=function(d){d=e.nodeToPost(d);b.broadcast("editPost",[d])},h=function(d){d=e.nodeToPost(d);b.removePost(d)};return b},edit_post:function(m,e){var e=e||{},b=k.trees.base(m,e),f=b.data,j=d.extend(b.config,m||{}),h=k.settings,
i=b.$el,c=j.nodePrefix+h.currentPost,a={crrm:{move:{check_move:b.checkMove}}},g=[],l=[],n;if(h.currentPost&&(g.push("#"+c),h.ancestors&&h.ancestors.length)){var p=h.ancestors.reverse();for(n=0;n<p.length;n++)l.push("#"+j.nodePrefix+h.ancestors[n])}g.length&&(a.ui={initially_select:g});l.length&&(a.core={initially_open:l});d.extend(!0,f.treeConfig,a);i.bind("before.jstree",function(a,b){switch(b.func){case "select_node":if("string"==typeof b.args[0]&&"#"+c!=b.args[0])return console.log("Selection prohibited 1!"),
console.log("Current post: #"+c),console.log("Args[0]: "+b.args[0]),!1;if(b.args[0]instanceof HTMLElement&&(console.log("Checking before selection:"),console.log("Current node ID: "+c),console.log("Parent LI ID: "+d(b.args[0]).parent("li").attr("id")),c!=d(b.args[0]).parent("li").attr("id")))return console.log("Selection prohibited 2!"),!1;if(b.args[0]instanceof jQuery&&c!=b.args[0].attr("id"))return console.log("Selection prohibited 3!"),!1;break;case "deselect_node":if(c==d(b.args[0]).parent("li").attr("id"))return console.log("Preventing deselection!"),
!1;break;case "hover_node":case "start_drag":var e=d(b.args[0]);if(c!=e.parent("li").attr("id"))return!1}});i.bind("move_node.jstree",function(a,c){var d=c.rslt.np,g=c.rslt.o.index()+1,d=i.attr("id")==d.attr("id")?0:parseInt(e.stripNodePrefix(d.attr("id")),10),f=e.nodeToPost(c.rslt.o);f.parent=d;f.menu_order=g;b.updatePost(f);b.broadcast("postMoved",[f,d,g])});b.checkMove=function(a){a.np.attr("id");return h.currentPost!=a.o.attr("id")?(console.log("No moving allowed -- illegal selection!"),!1):-1===
a.cr&&!k.settings.allowTop?(console.log("Move denied, top level posts cannot be created!"),!1):!0};b.getCurrentPost=function(){if(null===h.currentPost||"undefined"===typeof h.currentPost)return!1;var a=e.getNodeForPost(h.currentPost);return e.nodeToPost(a)};b.setCurrentPost=function(a){var d=e.getNodeForPost(a);h.currentPost=a.ID;c=d.attr("id");b.selectPost(a)};return b}}})(jQuery);