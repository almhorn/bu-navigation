var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(d){var q={listenFor:function(e,c){var f=this._listeners;void 0===f[e]&&(f[e]=[]);f[e].push(c)},broadcast:function(e,c){var f,d=this._listeners;if(d[e])for(f=0;f<d[e].length;f+=1)d[e][f].apply(this,c||[])}};bu.signals={register:function(e){e._listeners={};d.extend(!0,e,q)}};var l={};bu.hooks={addFilter:function(e,c){void 0===l[e]&&(l[e]=[]);l[e].push(c);return this},applyFilters:function(e,c){if(void 0===l[e])return c;var f=Array.prototype.slice.apply(arguments).slice(1),d=c,b;for(b=0;b<
l[e].length;b+=1)d=l[e][b].apply(this,f);return d}}})(jQuery);
(function(d){var q=bu.plugins.navigation;q.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0};d(document).ready(function(){!0===d.browser.msie&&7==parseInt(d.browser.version,10)&&d(document.body).addClass("ie7");!0===d.browser.msie&&8==parseInt(d.browser.version,10)&&d(document.body).addClass("ie8");!0===d.browser.msie&&9==parseInt(d.browser.version,10)&&d(document.body).addClass("ie9")});q.tree=function(d,e){"undefined"===typeof d&&(d="base");return q.trees[d](e).initialize()};
q.trees={base:function(l,e){var c={},e=e||{};bu.signals.register(c);c.config=d.extend({},q.settings,l||{});c.data={treeConfig:{},rollback:void 0};var f=c.config,g=c.data,b=c.$el=d(f.el);if(f.themePath&&document.images){var j=new Image,p=new Image;j.src=f.themePath+"/sprite.png";p.src=f.themePath+"/throbber.gif"}var j=function(a){return bu.hooks.applyFilters("canSelectNode",a,c)},p=function(a){return bu.hooks.applyFilters("canHoverNode",a,c)},k=function(a){return bu.hooks.applyFilters("canDragNode",
a,c)};g.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:p,start_drag:k},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:p,start_drag:k},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:p,start_drag:k},link:{max_children:0,
max_depth:0,valid_children:"none",select_node:j,hover_node:p,start_drag:k}}},json_data:{ajax:{url:f.rpcUrl,type:"POST",data:function(a){return{child_of:(-1===a?{ID:0}:e.nodeToPost(a)).ID,post_types:f.postTypes,post_statuses:f.postStatuses,instance:f.instance,prefix:f.nodePrefix}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var h=e.nodeToPost(a.o),i,d=!0;i=!1===h.post_meta.excluded||"link"===h.post_type;var s=!h.originalExclude&&(0===h.originalParent||"new"===
h.post_status&&"link"!==h.post_type);-1===a.cr&&(!s&&i&&!f.allowTop)&&(d=!1);a.np.length&&a.np.attr("id")!==b.attr("id")&&(i=e.nodeToPost(a.np),"publish"==h.post_status&&"publish"!=i.post_status&&(d=!1));return bu.hooks.applyFilters("moveAllowed",d,a,c)}}},bu:{lazy_load:f.lazyLoad}};f.showCounts&&(g.treeConfig.json_data.progressive_render=!1);f.initialTreeData&&(g.treeConfig.json_data.data=f.initialTreeData);g.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",g.treeConfig,b);c.initialize=function(){b.jstree(g.treeConfig);
return c};c.selectPost=function(a,h){var h=h||!0,c=e.getNodeForPost(a);h&&b.jstree("deselect_all");b.jstree("select_node",c)};c.getSelectedPost=function(){var a=b.jstree("get_selected");return a.length?e.nodeToPost(a):!1};c.deselectAll=function(){b.jstree("deselect_all")};c.getPost=function(a){return(a=e.getNodeForPost(a))?e.nodeToPost(a):!1};c.getPosts=function(a){var h=[],i={};(a?d.jstree._reference(b)._get_node("#"+a):b).find("> ul > li").each(function(a,b){b=d(b);i=e.nodeToPost(b);b.find("> ul > li").length&&
(i.children=c.getPosts(b.attr("id")));h.push(i)});return h};c.showAll=function(){b.jstree("open_all")};c.hideAll=function(){b.jstree("close_all")};c.getPostLabel=function(a){a=e.getNodeForPost(a);return b.jstree("get_text",a)};c.setPostLabel=function(a,h){var c=e.getNodeForPost(a);b.jstree("set_text",c,h)};c.insertPost=function(a){var h,i;if("undefined"===typeof a)throw new TypeError("Post argument for insertPost must be defined!");var d,f,m;a.post_parent=a.post_parent||0;a.menu_order=a.menu_order||
1;a.post_parent?(h=e.getNodeForPost(a.post_parent),d=c.getPost(a.post_parent)):h=b;1==a.menu_order?(f=h.find("> ul > li").get(0),i="before"):(m=a.menu_order-2,0<=m&&(f=h.find("> ul > li").get(m),i="after"));f||(f=h,i="inside");h=f;a=bu.hooks.applyFilters("preInsertPost",a,d);d=e.postToNode(a);d=b.jstree("create",h,i,d,function(a){b.jstree("deselect_all");b.jstree("select_node",a)},!0);a.ID||(a.ID=d.attr("id"));return a};c.updatePost=function(a){var h=e.getNodeForPost(a),i;return h?(i=e.nodeToPost(h),
a=d.extend(!0,{},i,a),b.jstree("set_text",h,a.post_title),a.post_parent=parseInt(a.post_parent,10),a.menu_order=parseInt(a.menu_order,10),h.data("post",a),f.showStatuses&&h.find("li").andSelf().each(function(){m(d(this))}),c.broadcast("postUpdated",[a]),a):!1};c.removePost=function(a){a&&"undefined"===typeof a?(a=b.jstree("get_selected"),e.nodeToPost(a)):a=e.getNodeForPost(a);b.jstree("remove",a)};c.getAncestors=function(a){a=e.getNodeForPost(a);return b.jstree("get_path",a)};c.save=function(){g.rollback=
b.jstree("get_rollback")};c.restore=function(){"undefined"!==typeof g.rollback&&(g.rollback.d.ui.selected=d([]),d.jstree.rollback(g.rollback),g.rollback=b.jstree("get_rollback"))};c.lock=function(){b.jstree("lock")};c.unlock=function(){b.jstree("unlock")};e.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var c,i;c=a.attr("id");i=d.extend({},!0,a.data("post"));-1===c.indexOf("post-new")&&(c=parseInt(e.stripNodePrefix(c),10));i.ID=c;i.post_title=b.jstree("get_text",
a);i.menu_order=a.index()+1;i.post_parent=parseInt(i.post_parent,10);i.originalParent=parseInt(i.originalParent,10);i.originalOrder=parseInt(i.originalOrder,10);i.post_meta=i.post_meta||{};return bu.hooks.applyFilters("nodeToPost",i,a)};e.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var c,a=d.extend({},{post_title:"(no title)",post_content:"",post_status:"new",post_type:"page",post_parent:0,menu_order:1,post_meta:{},url:""},a);c=a.ID?f.nodePrefix+a.ID:"post-new-"+
e.getNextPostID();return bu.hooks.applyFilters("postToNode",{attr:{id:c,rel:a.post_type},data:{title:a.post_title},metadata:{post:a}},a)};e.getNodeForPost=function(a){if("undefined"===typeof a)return!1;a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=f.nodePrefix+a);a=d.jstree._reference(b)._get_node("#"+a);return a.length?a:!1};e.getNextPostID=function(){return d('[id*="post-new-"]').length};e.stripNodePrefix=function(a){return a.replace(f.nodePrefix,"")};var n=
function(a,c){var e=a.find("li").length,b=a.children("a");0===b.children(".title-count").children(".count").length&&b.children(".title-count").append('<span class="count"></span>');b=b.find("> .title-count > .count").empty();e?b.text("("+e+")"):b.text("");c&&a.find("li").each(function(){n(d(this))})},m=function(a){var c=a.children("a");0===c.children(".post-statuses").length&&c.append('<span class="post-statuses"></span>');var a=e.nodeToPost(a),b,d,f;d=a.post_meta.excluded||!1;f=a.post_meta.restricted||
!1;pass_protected=a.post_meta["protected"]||!1;c=c.children(".post-statuses").empty();b=[];"publish"!=a.post_status&&b.push({"class":a.post_status,label:a.post_status});d&&b.push({"class":"excluded",label:"not in nav"});f&&b.push({"class":"restricted",label:"restricted"});pass_protected&&b.push({"class":"protected",label:"protected"});for(a=0;a<b.length;a+=1)c.append('<span class="post_status '+b[a]["class"]+'">'+b[a].label+"</span>")},r=function(a){0===a.children("ul").length?a.attr("rel","page"):
a.attr("rel","section");f.showCounts&&(a=a.parent("ul").parent("div").attr("id")!=b.attr("id")?a.parents("li:last"):a,n(a,!0))};b.bind("loaded.jstree",function(){var a=b.find("> ul > li:first-child"),a=18<=a.height()?a.height():32;b.jstree("data").data.core.li_height=a;c.broadcast("postsLoaded")});b.bind("reselect.jstree",function(){c.broadcast("postsSelected")});b.bind("lazy_loaded.jstree",function(){c.broadcast("lazyLoadComplete")});b.bind("load_node.jstree",function(a,c){if(-1!==c.rslt.obj){var b=
c.rslt.obj;f.showCounts&&n(b,!0)}});b.bind("clean_node.jstree",function(a,c){var b=c.rslt.obj;b&&-1!==b&&b.each(function(a,c){var b=d(c);b.data("buNavExtrasAdded")||(f.showStatuses&&m(b),b.data("buNavExtrasAdded",!0))})});b.bind("before.jstree",function(a,c){var b;switch(c.func){case "select_node":case "hover_node":case "start_drag":if((b=c.inst._get_node(c.args[0]))&&b.hasClass("denied"))return!1}});b.bind("create_node.jstree",function(a,b){var d=e.nodeToPost(b.rslt.obj);c.broadcast("postCreated",
[d])});b.bind("select_node.jstree",function(a,b){var d=e.nodeToPost(b.rslt.obj);c.broadcast("postSelected",[d])});b.bind("create.jstree",function(a,b){var d=b.rslt.parent,f=b.rslt.position,m=e.nodeToPost(b.rslt.obj),g=null;-1!==d&&(g=e.nodeToPost(d),r(d));m.post_parent=g?g.ID:0;m.menu_order=f+1;c.broadcast("postInserted",[m])});b.bind("remove.jstree",function(a,b){var f=b.rslt.obj,m=e.nodeToPost(f),g=b.rslt.parent,j;-1!==g&&r(g);c.broadcast("postRemoved",[m]);f.find("li").each(function(){(j=e.nodeToPost(d(this)))&&
c.broadcast("postRemoved",[j])})});b.bind("deselect_node.jstree",function(a,b){var d=e.nodeToPost(b.rslt.obj);c.broadcast("postDeselected",[d])});b.bind("deselect_all.jstree",function(){c.broadcast("postsDeselected")});b.bind("move_node.jstree",function(a,f){f.rslt.o.each(function(a,m){var g=d(m),j=e.nodeToPost(g),k=f.rslt.np,l=f.rslt.op,g=g.index()+1,n=0,p=0,q=1;b.attr("id")!==k.attr("id")&&(r(k),n=parseInt(e.stripNodePrefix(k.attr("id")),10));b.attr("id")!==l.attr("id")&&!k.is("#"+l.attr("id"))&&
(r(l),k=e.nodeToPost(l),p=k.ID);q=j.menu_order;j.post_parent=n;j.menu_order=g;c.updatePost(j);c.broadcast("postMoved",[j,p,q])})});j=function(a){var c=d.contains(b[0],a.target),a=d.contains(d("#vakata-contextmenu")[0],a.target);!c&&!a&&b.jstree("deselect_all")};f.deselectOnDocumentClick&&d(document).bind("click",j);return c},navman:function(l,e){var c={},e=e||{},c=q.trees.base(l,e),f=c.$el,g=c.data,b=function(b){b=e.nodeToPost(b);c.broadcast("editPost",[b])},j=function(b){b=e.nodeToPost(b);b.url&&
window.open(b.url)},p=function(b){b=e.nodeToPost(b);c.removePost(b)};g.treeConfig.plugins.push("contextmenu");g.treeConfig.contextmenu={show_at_node:!1,items:function(c){var d=e.nodeToPost(c),a={edit:{label:"Edit",action:b},view:{label:"View",action:j},remove:{label:"Move to Trash",action:p}};d.url||delete a.view;"link"===d.post_type&&(a.remove.label="Delete");return bu.hooks.applyFilters("navmanOptionsMenuItems",a,c)}};f.bind("loaded.jstree",function(){f.undelegate("a","contextmenu.jstree")});f.bind("clean_node.jstree",
function(b,c){var a=c.rslt.obj;a&&-1!=a&&a.each(function(a,b){var c=d(b).children("a");if(!c.children(".edit-options").length){var e=d('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),f=c.children(".post-statuses");f.length?f.before(e):c.append(e)}})});var k=null;f.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var b=d(this).offset(),c=d(this).height()+5,a=d(this).parent("a").parent("li");f.jstree("deselect_all");d(this).addClass("clicked");
f.jstree("select_node",a);f.jstree("show_contextmenu",a,b.left,b.top+c);k&&k.attr("id")!=a.attr("id")&&n(k);k=a});d(document).bind("context_hide.vakata",function(){n(k)});var n=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};f.addClass("bu-navman");return c},edit_post:function(l,e){var e=e||{},c=q.trees.base(l,e),f=c.data,g=d.extend(c.config,l||{}),b=c.$el,j=g.currentPost,p={},k=[],n;if(g.ancestors&&g.ancestors.length){var m=g.ancestors.reverse();for(n=0;n<m.length;n+=1)k.push("#"+
g.nodePrefix+g.ancestors[n])}k.length&&(p.core={initially_open:k});d.extend(!0,f.treeConfig,p);f=function(b,a){if(a.$el.is(c.$el.selector))return e.stripNodePrefix(b.attr("id"))==j.ID};bu.hooks.addFilter("canSelectNode",f);bu.hooks.addFilter("canHoverNode",f);bu.hooks.addFilter("canDragNode",f);b.bind("reselect.jstree",function(){e.getNodeForPost(j)||c.insertPost(j);0===b.jstree("get_selected").length&&(c.selectPost(j),c.save())});c.getCurrentPost=function(){var b;return(b=e.getNodeForPost(j))?b=
e.nodeToPost(b):!1};c.setCurrentPost=function(b){j=b};c.scrollToSelection=function(){var c=b.jstree("get_selected");if(c.length){d(document);b.css("overflow");var a=b.innerHeight(),c=c.position().top+c.height()/2-a/2;0<c&&b.scrollTop(c)}};b.addClass("bu-edit-post");return c}}})(jQuery);