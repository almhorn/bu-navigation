var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var f={},j=this;return{listenFor:function(i,d){void 0===f[i]&&(f[i]=[]);f[i].push(d);return j},broadcast:function(i,d){var b=0;if(f[i])for(b;b<f[i].length;b+=1)f[i][b].apply(this,d||[]);return j}}}();bu.hooks=function(){var f={},j=this;return{addFilter:function(i,d){void 0===f[i]&&(f[i]=[]);f[i].push(d);return j},applyFilters:function(i,d){if(void 0===f[i])return d;for(var b=Array.prototype.slice.apply(arguments).slice(1),g=0,j=d,g=0;g<f[i].length;g+=1)j=f[i][g].apply(this,
b);return j}}}()})(jQuery);
(function(f){var j=bu.plugins.navigation;j.settings=buNavSettings||{};f(document).ready(function(){!0===f.browser.msie&&7==parseInt(f.browser.version,10)&&f(document.body).addClass("ie7");!0===f.browser.msie&&8==parseInt(f.browser.version,10)&&f(document.body).addClass("ie8")});j.tree=function(f,d){"undefined"===typeof f&&(f="base");return j.trees[f](d).initialize()};j.trees={base:function(i,d){var b={},d=d||{};f.extend(!0,b,bu.signals);b.config=f.extend({},{el:"#nav-tree-container",format:j.settings.format,
postStatuses:j.settings.postStatuses,nodePrefix:j.settings.nodePrefix},i||{});b.data={treeConfig:{},rollback:void 0};var g=j.settings,n=b.config,h=b.data,c=b.$el=f(n.el);if(0===c.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");var l=function(a){return bu.hooks.applyFilters("canSelectNode",a)},q=function(a){return bu.hooks.applyFilters("canHoverNode",a)},m=function(a){return bu.hooks.applyFilters("canDragNode",a)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),
core:{animation:0,html_titles:!0},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:q,start_drag:m},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:q,start_drag:m},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:q,start_drag:m},link:{max_children:0,max_depth:0,valid_children:"none",select_node:l,hover_node:q,start_drag:m},denied:{select_node:!1,hover_node:!1,
start_drag:!1}}},json_data:{ajax:{url:g.rpcUrl,type:"POST",data:function(a){return{id:a.attr?d.stripNodePrefix(a.attr("id")):0,format:n.format,prefix:n.nodePrefix,post_status:n.postStatuses}}},progressive_render:!0},crrm:{move:{check_move:function(a){var b=d.nodeToPost(a.o),e=!0;-1===a.cr&&(!1===b.meta.excluded&&!j.settings.allowTop)&&(e=!1);return bu.hooks.applyFilters("moveAllowed",e,a)}}},bu:{lazy_load:!0}};g.showCounts&&(h.treeConfig.json_data.progressive_render=!1);g.initialTreeData&&(h.treeConfig.json_data.data=
g.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",h.treeConfig,c);b.initialize=function(){c.jstree(h.treeConfig);return b};b.selectPost=function(a){a=d.getNodeForPost(a);c.jstree("select_node",a)};b.getSelected=function(){var a=c.jstree("get_selected");return d.nodeToPost(a)};b.getPost=function(a){a=d.getNodeForPost(a);return d.nodeToPost(a)};b.getPosts=function(){return c.jstree("get_json",-1)};b.showAll=function(){c.jstree("open_all")};b.hideAll=function(){c.jstree("close_all")};
b.getPostLabel=function(a){a=d.getNodeForPost(a);return c.jstree("get_text",a)};b.setPostLabel=function(a,b){var e=d.getNodeForPost(a);c.jstree("set_text",e,b)};b.insertPost=function(a,k){var e=f.extend({position:"after",which:null,skip_rename:!0,callback:null},k),g=d.postToNode(a);c.jstree("create",e.which,e.position,g,e.callback,e.skip_rename);a.ID=d.stripNodePrefix(g.attr.id);b.broadcast("insertPost",[a]);return a};b.updatePost=function(a){var k=d.getNodeForPost(a),e;k&&(e=d.nodeToPost(k),e=f.extend(!0,
{},e,a),c.jstree("set_text",k,e.title),k.data("post_content",e.content),k.data("post_title",e.title),k.data("post_status",e.status),k.data("post_type",e.type),k.data("post_parent",parseInt(e.parent,10)),k.data("menu_order",parseInt(e.menu_order,10)),k.data("post_meta",e.meta));r(k);b.broadcast("updatePost",[e]);return e};b.removePost=function(a){var k;a&&"undefined"===typeof a?(k=c.jstree("get_selected"),a=d.nodeToPost(k)):k=d.getNodeForPost(a);c.jstree("remove",k);b.broadcast("removePost",[a])};
b.getAncestors=function(a){a=d.getNodeForPost(a);return c.jstree("get_path",a)};b.save=function(){h.rollback=c.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof h.rollback&&(h.rollback.d.ui.selected=f([]),f.jstree.rollback(h.rollback),h.rollback=c.jstree("get_rollback"))};d.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var b=a.attr("id");-1===b.indexOf("post-new")&&(b=d.stripNodePrefix(b));a={ID:b,title:c.jstree("get_text",a),content:a.data("post_content"),
status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:parseInt(a.data("menu_order"),10),meta:a.data("post_meta")||{}};return bu.hooks.applyFilters("nodeToPost",a)};d.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var b={ID:d.getNextPostID(),title:"Untitled Post",content:"",status:"new",type:"page",parent:0,menu_order:0,meta:{}},a=f.extend({},b,a);return bu.hooks.applyFilters("postToNode",{attr:{id:a.ID?n.nodePrefix+
a.ID:"post-new-"+a.ID,rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,post_parent:a.parent,menu_order:a.menu_order,post_meta:a.meta}})};d.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID:a;-1===a.indexOf("post-new")&&(a=n.nodePrefix+a);a=f.jstree._reference(c)._get_node("#"+a);return a.length?a:!1};d.getNextPostID=function(){return f('[id*="post-new-"]').length};d.stripNodePrefix=
function(a){return a.replace(n.nodePrefix,"")};var p=function(a,b){"undefined"===typeof b&&(b=!0);var e=a.find("li").length,d=a.children("a");if(e){var c=d.children(".count");if(0===c.length){var g=d.children(".edit-options"),c=f('<span class="count"></span>');g.length?g.before(c):d.append(c)}c.text("("+e+")")}else d.children(".count").remove();b&&a.find("> ul > li").each(function(){p(f(this))})},r=function(a){var b=a.children("a");0===b.children(".post-statuses").length&&b.append('<span class="post-statuses"></span>');
var a=d.nodeToPost(a),e=a.meta.excluded||!1,f=a.meta.restricted||!1,b=b.children(".post-statuses").empty(),c=[];"publish"!=a.status&&c.push({"class":a.status,label:a.status});e&&c.push({"class":"excluded",label:"not in nav"});f&&c.push({"class":"restricted",label:"restricted"});c=bu.hooks.applyFilters("navPostStatuses",c);for(a=0;a<c.length;a++)b.append('<span class="post_status '+c[a]["class"]+'">'+c[a].label+"</span>")};c.bind("loaded.jstree",function(){var a=c.find("> ul > li:first-child"),a=18<=
a.height()?a.height():37;c.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});c.bind("reselect.jstree",function(){c.data("initial-save")||(c.data("initial-save",!0),b.save());b.broadcast("postsSelected")});c.bind("load_node.jstree",function(a,b){if(-1!==b.rslt.obj){var e=b.rslt.obj;g.showCounts&&p(e)}});c.bind("clean_node.jstree",function(a,b){var e=b.rslt.obj;e&&-1!==e&&e.each(function(a,b){var e=f(b);0===e.find("> a > .post-statuses").length&&r(e)})});c.bind("create_node.jstree",
function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("postCreated",[e])});c.bind("select_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("selectPost",[e,b])});c.bind("deselect_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("deselectPost",[e,b])});c.bind("move_node.jstree",function(a,f){var e=f.rslt.np,l=f.rslt.op,i=f.rslt.o.index()+1,j,h,m;j=c.attr("id")==e.attr("id")?0:parseInt(d.stripNodePrefix(e.attr("id")),10);"section"===l.attr("rel")&&0===l.children("ul").length&&
l.attr("rel","page");"page"===e.attr("rel")&&e.attr("rel","section");g.showCounts&&(h=e.parentsUntil("#"+c.attr("id"),"li"),m=l.parentsUntil("#"+c.attr("id"),"li"),h=h.length?h.last():e,m=m.length?m.last():l,m.is("#"+h.attr("id"))||p(m),p(h));e=d.nodeToPost(f.rslt.o);e.parent=j;e.menu_order=i;b.updatePost(e);b.broadcast("postMoved",[e,j,i])});return b},navman:function(i,d){var b={},d=d||{},b=j.trees.base(i,d),g=b.$el,n=b.data;n.treeConfig.plugins.push("contextmenu");n.treeConfig.contextmenu={show_at_node:!1,
items:function(){return{edit:{label:"Edit",action:h,icon:"remove"},remove:{label:"Remove",action:c}}}};var h=function(c){c=d.nodeToPost(c);b.broadcast("editPost",[c])},c=function(c){c=d.nodeToPost(c);b.removePost(c)};g.bind("loaded.jstree",function(){g.undelegate("a","contextmenu.jstree")});g.bind("clean_node.jstree",function(b,c){var d=c.rslt.obj;d&&-1!=d&&d.each(function(b,c){var a=f(c).children("a");if(!a.children(".edit-options").length){var d=f('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),
e=a.children(".post-statuses");e.length?e.before(d):a.append(d)}})});g.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();g.jstree("deselect_all");var b=f(this).offset(),c=f(this).height()+5,d=f(this).parent("a").parent("li");f(this).addClass("clicked");g.jstree("select_node",d);g.jstree("show_contextmenu",d,b.left,b.top+c)});g.bind("deselect_all.jstree",function(b,c){var d=c.rslt.obj;d.attr("id")!==g.attr("id")&&d.find("> a > .edit-options").removeClass("clicked")});
f(document).bind("mousedown",function(b){0===g.jstree("get_selected",g).filter(b.target).length&&g.jstree("deselect_all")});return b},edit_post:function(i,d){var d=d||{},b=j.trees.base(i,d),g=b.data,n=f.extend(b.config,i||{}),h=j.settings,c=b.$el,l=h.currentPost,q=n.nodePrefix+l,m={},p=[],r=[],a;if(l&&(p.push("#"+q),h.ancestors&&h.ancestors.length)){var k=h.ancestors.reverse();for(a=0;a<k.length;a++)r.push("#"+n.nodePrefix+h.ancestors[a])}p.length&&(m.ui={initially_select:p});r.length&&(m.core={initially_open:r});
f.extend(!0,g.treeConfig,m);g=function(a){return d.stripNodePrefix(a.attr("id"))==l};bu.hooks.addFilter("canSelectNode",g);bu.hooks.addFilter("canHoverNode",g);bu.hooks.addFilter("canDragNode",g);b.getCurrentPost=function(){if(null===l||"undefined"===typeof l)return!1;var a=d.getNodeForPost(l);return d.nodeToPost(a)};b.setCurrentPost=function(a){var c=d.getNodeForPost(a);l=a.ID;q=c.attr("id");b.selectPost(a)};b.scrollToSelection=function(){var a=c.jstree("get_selected");if(a.length){f(document);c.css("overflow");
var b=c.innerHeight(),a=a.position().top+a.height()/2-b/2;0<a&&c.scrollTop(a)}};return b}}})(jQuery);