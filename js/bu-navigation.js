var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(d){var p={listenFor:function(b,c){var f=this._listeners;void 0===f[b]&&(f[b]=[]);f[b].push(c)},broadcast:function(b,c){var f,d=this._listeners;if(d[b])for(f=0;f<d[b].length;f+=1)d[b][f].apply(this,c||[])}};bu.signals={register:function(b){b._listeners={};d.extend(!0,b,p)}};var m={};bu.hooks={addFilter:function(b,c){void 0===m[b]&&(m[b]=[]);m[b].push(c);return this},applyFilters:function(b,c){if(void 0===m[b])return c;var f=Array.prototype.slice.apply(arguments).slice(1),d=c,e;for(e=0;e<
m[b].length;e+=1)d=m[b][e].apply(this,f);return d}}})(jQuery);
(function(d){var p=bu.plugins.navigation;p.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0};d(document).ready(function(){!0===d.browser.msie&&7==parseInt(d.browser.version,10)&&d(document.body).addClass("ie7");!0===d.browser.msie&&8==parseInt(d.browser.version,10)&&d(document.body).addClass("ie8");!0===d.browser.msie&&9==parseInt(d.browser.version,10)&&d(document.body).addClass("ie9")});p.tree=function(d,b){"undefined"===typeof d&&(d="base");return p.trees[d](b).initialize()};
p.trees={base:function(m,b){var c={},b=b||{};bu.signals.register(c);c.config=d.extend({},p.settings,m||{});c.data={treeConfig:{},rollback:void 0};var f=c.config,i=c.data,e=c.$el=d(f.el);if(0===e.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");if(f.themePath&&document.images){var j=new Image,l=new Image;j.src=f.themePath+"/sprite.png";l.src=f.themePath+"/throbber.gif"}var j=function(a){return bu.hooks.applyFilters("canSelectNode",a,c)},l=function(a){return bu.hooks.applyFilters("canHoverNode",
a,c)},n=function(a){return bu.hooks.applyFilters("canDragNode",a,c)};i.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:l,start_drag:n},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:l,start_drag:n},section:{max_children:-1,max_depth:-1,valid_children:"all",
select_node:j,hover_node:l,start_drag:n},link:{max_children:0,max_depth:0,valid_children:"none",select_node:j,hover_node:l,start_drag:n},denied:{select_node:!1,hover_node:!1,start_drag:!1}}},json_data:{ajax:{url:f.rpcUrl,type:"POST",data:function(a){return{child_of:a.attr?b.stripNodePrefix(a.attr("id")):0,post_types:f.postTypes,post_statuses:f.postStatuses,instance:f.instance,prefix:f.nodePrefix}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var g=b.nodeToPost(a.o),
d,q=!0;d=!1===g.meta.excluded||"link"===g.type;var h=!g.originalExclude&&(0===g.originalParent||"new"===g.status);-1===a.cr&&(!h&&d&&!f.allowTop)&&(q=!1);a.np.length&&a.np.attr("id")!==e.attr("id")&&(d=b.nodeToPost(a.np),"publish"==g.status&&"publish"!=d.status&&(q=!1));return bu.hooks.applyFilters("moveAllowed",q,a,c)}}},bu:{lazy_load:f.lazyLoad}};f.showCounts&&(i.treeConfig.json_data.progressive_render=!1);f.initialTreeData&&(i.treeConfig.json_data.data=f.initialTreeData);i.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",
i.treeConfig,e);c.initialize=function(){e.jstree(i.treeConfig);return c};c.selectPost=function(a,g){var g=g||!0,c=b.getNodeForPost(a);g&&e.jstree("deselect_all");e.jstree("select_node",c)};c.getSelectedPost=function(){var a=e.jstree("get_selected");return a.length?b.nodeToPost(a):!1};c.deselectAll=function(){e.jstree("deselect_all")};c.getPost=function(a){return(a=b.getNodeForPost(a))?b.nodeToPost(a):!1};c.getPosts=function(a){var g=[],f={},q,h;(a?d.jstree._reference(e)._get_node("#"+a):e).find("> ul > li").each(function(a,
k){k=d(k);q=k.attr("id");h=k.data("post_type");"new"!=h&&(q=b.stripNodePrefix(q));f={ID:q,type:h,status:k.data("post_status"),title:e.jstree("get_text",k),content:k.data("post_content"),meta:k.data("post_meta")};k.find("> ul > li").length&&(f.children=c.getPosts(k.attr("id")));g.push(f)});return g};c.showAll=function(){e.jstree("open_all")};c.hideAll=function(){e.jstree("close_all")};c.getPostLabel=function(a){a=b.getNodeForPost(a);return e.jstree("get_text",a)};c.setPostLabel=function(a,g){var c=
b.getNodeForPost(a);e.jstree("set_text",c,g)};c.insertPost=function(a){var g;if("undefined"===typeof a)throw new TypeError("Post argument for insertPost must be defined!");var d,f;a.parent=a.parent||0;a.menu_order=a.menu_order||1;a.parent?(g=b.getNodeForPost(a.parent),d=c.getPost(a.parent)):g=e;f=a.menu_order-2;g=(f=0<=f?g.find("> ul > li").get(f):null)?"after":"before";a=bu.hooks.applyFilters("preInsertPost",a,d);d=b.postToNode(a);d=e.jstree("create",f,g,d,function(a){e.jstree("deselect_all");e.jstree("select_node",
a)},!0);a.ID||(a.ID=d.attr("id"));return a};c.updatePost=function(a){var g=b.getNodeForPost(a),h;return g?(h=b.nodeToPost(g),a=d.extend(!0,{},h,a),e.jstree("set_text",g,a.title),g.data("post_content",a.content),g.data("post_title",a.title),g.data("post_status",a.status),g.data("post_type",a.type),g.data("post_parent",parseInt(a.parent,10)),g.data("menu_order",parseInt(a.menu_order,10)),g.data("post_meta",a.meta),f.showStatuses&&(r(g),k(g)),c.broadcast("postUpdated",[a]),a):!1};c.removePost=function(a){a&&
"undefined"===typeof a?(a=e.jstree("get_selected"),b.nodeToPost(a)):a=b.getNodeForPost(a);e.jstree("remove",a)};c.getAncestors=function(a){a=b.getNodeForPost(a);return e.jstree("get_path",a)};c.save=function(){i.rollback=e.jstree("get_rollback")};c.restore=function(){"undefined"!==typeof i.rollback&&(d.jstree.rollback(i.rollback),i.rollback=e.jstree("get_rollback"))};c.lock=function(){e.jstree("lock")};c.unlock=function(){e.jstree("unlock")};b.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");
var g=a.attr("id");-1===g.indexOf("post-new")&&(g=parseInt(b.stripNodePrefix(g),10));g={ID:g,title:e.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:a.index()+1,meta:a.data("post_meta")||{},originalParent:parseInt(a.data("originalParent"),10),originalOrder:parseInt(a.data("originalOrder"),10),originalExclude:a.data("originalExclude"),inheritedExclusion:a.data("inheritedExclusion")||!1,inheritedRestriction:a.data("inheritedRestriction")||
!1};return bu.hooks.applyFilters("nodeToPost",g,a)};b.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var g,a=d.extend({},{title:"(no title)",content:"",status:"new",type:"page",parent:0,menu_order:1,meta:{}},a);g=a.ID?f.nodePrefix+a.ID:"post-new-"+b.getNextPostID();return bu.hooks.applyFilters("postToNode",{attr:{id:g,rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,post_parent:a.parent,menu_order:a.menu_order,
post_meta:a.meta,originalParent:a.originalParent,originalOrder:a.originalOrder,originalExclude:a.originalExclude}},a)};b.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=f.nodePrefix+a);a=d.jstree._reference(e)._get_node("#"+a);return a.length?a:!1};b.getNextPostID=function(){return d('[id*="post-new-"]').length};b.stripNodePrefix=function(a){return a.replace(f.nodePrefix,
"")};var h=function(a,g){var g=g||!0,c=a.find("li").length,b=a.children("a");0===b.children(".title-count").children(".count").length&&b.children(".title-count").append('<span class="count"></span>');b=b.find("> .title-count > .count").empty();c?b.text("("+c+")"):b.text("");g&&a.find("> ul > li").each(function(){h(d(this))})},r=function(a){b.nodeToPost(a);a.parentsUntil("#"+e.attr("id"),"li").filter(function(){return d(this).data("post_meta").excluded}).length?a.data("inheritedExclusion",!0):a.data("inheritedExclusion",
!1);a.parentsUntil("#"+e.attr("id"),"li").filter(function(){return d(this).data("post_meta").restricted}).length?a.data("inheritedRestriction",!0):a.data("inheritedRestriction",!1)},k=function(a){var g=a.children("a");0===g.children(".post-statuses").length&&g.append('<span class="post-statuses"></span>');var a=b.nodeToPost(a),c=a.meta.excluded||a.inheritedExclusion||!1,e=a.meta.restricted||a.inheritedRestriction||!1,g=g.children(".post-statuses").empty(),d=[];"publish"!=a.status&&d.push({"class":a.status,
label:a.status});c&&d.push({"class":"excluded",label:"not in nav"});e&&d.push({"class":"restricted",label:"restricted"});for(a=0;a<d.length;a++)g.append('<span class="post_status '+d[a]["class"]+'">'+d[a].label+"</span>")},s=function(a){0===a.children("ul").length?a.attr("rel","page"):a.attr("rel","section");f.showCounts&&(a=a.parent("ul").parent("div").attr("id")!=e.attr("id")?a.parents("li:last"):a,h(a))};e.bind("loaded.jstree",function(){var a=e.find("> ul > li:first-child"),a=18<=a.height()?a.height():
32;e.jstree("data").data.core.li_height=a;c.broadcast("postsLoaded")});e.bind("reselect.jstree",function(){c.broadcast("postsSelected")});e.bind("lazy_loaded.jstree",function(){c.broadcast("lazyLoadComplete")});e.bind("load_node.jstree",function(a,c){if(-1!==c.rslt.obj){var b=c.rslt.obj;f.showCounts&&h(b)}});e.bind("clean_node.jstree",function(a,c){var b=c.rslt.obj;b&&-1!==b&&b.each(function(a,c){var b=d(c);b.data("bu-nav-extras-added")||(f.showStatuses&&(r(b),k(b)),b.data("bu-nav-extras-added",!0))})});
e.bind("create_node.jstree",function(a,g){var d=b.nodeToPost(g.rslt.obj);c.broadcast("postCreated",[d])});e.bind("select_node.jstree",function(a,g){var d=b.nodeToPost(g.rslt.obj);c.broadcast("postSelected",[d])});e.bind("create.jstree",function(a,g){var d=g.rslt.parent,e=g.rslt.position,f=b.nodeToPost(g.rslt.obj),h=null;-1!==d&&(h=b.nodeToPost(d),s(d));f.parent=h?h.ID:0;f.menu_order=e+1;c.broadcast("postInserted",[f])});e.bind("remove.jstree",function(a,g){var e=g.rslt.obj,f=b.nodeToPost(e),h=g.rslt.parent,
k;-1!==h&&s(h);c.broadcast("postRemoved",[f]);e.find("li").each(function(){(k=b.nodeToPost(d(this)))&&c.broadcast("postRemoved",[k])})});e.bind("deselect_node.jstree",function(a,d){var e=b.nodeToPost(d.rslt.obj);c.broadcast("postDeselected",[e])});e.bind("deselect_all.jstree",function(){c.broadcast("postsDeselected")});e.bind("move_node.jstree",function(a,g){g.rslt.o.each(function(a,f){var h=d(f),k=b.nodeToPost(h),i=g.rslt.np,j=g.rslt.op,h=h.index()+1,l=0,m=0,n=1;e.attr("id")!==i.attr("id")&&(s(i),
l=parseInt(b.stripNodePrefix(i.attr("id")),10));e.attr("id")!==j.attr("id")&&!i.is("#"+j.attr("id"))&&(s(j),i=b.nodeToPost(j),m=i.ID);n=k.menu_order;k.parent=l;k.menu_order=h;c.updatePost(k);c.broadcast("postMoved",[k,m,n])})});j=function(a){var b=d.contains(e[0],a.target),a=d.contains(d("#vakata-contextmenu")[0],a.target);!b&&!a&&e.jstree("deselect_all")};f.deselectOnDocumentClick&&d(document).bind("click",j);return c},navman:function(m,b){var c={},b=b||{},c=p.trees.base(m,b),f=c.$el,i=c.data;i.treeConfig.plugins.push("contextmenu");
i.treeConfig.contextmenu={show_at_node:!1,items:function(b){return bu.hooks.applyFilters("navmanContextItems",{edit:{label:"Edit",action:e,icon:"remove"},remove:{label:"Move to Trash",action:j}},b)}};var e=function(d){d=b.nodeToPost(d);c.broadcast("editPost",[d])},j=function(d){d=b.nodeToPost(d);c.removePost(d)};f.bind("loaded.jstree",function(){f.undelegate("a","contextmenu.jstree")});f.bind("clean_node.jstree",function(b,c){var e=c.rslt.obj;e&&-1!=e&&e.each(function(b,a){var c=d(a).children("a");
if(!c.children(".edit-options").length){var e=d('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),f=c.children(".post-statuses");f.length?f.before(e):c.append(e)}})});var l=null;f.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var b=d(this).offset(),c=d(this).height()+5,e=d(this).parent("a").parent("li");f.jstree("deselect_all");d(this).addClass("clicked");f.jstree("select_node",e);f.jstree("show_contextmenu",e,b.left,b.top+
c);l&&l.attr("id")!=e.attr("id")&&n(l);l=e});d(document).bind("context_hide.vakata",function(){n(l)});var n=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};f.addClass("bu-navman");return c},edit_post:function(m,b){var b=b||{},c=p.trees.base(m,b),f=c.data,i=d.extend(c.config,m||{}),e=c.$el,j=i.currentPost,l={},n=[],h;if(i.ancestors&&i.ancestors.length){var r=i.ancestors.reverse();for(h=0;h<r.length;h+=1)n.push("#"+i.nodePrefix+i.ancestors[h])}n.length&&(l.core={initially_open:n});
d.extend(!0,f.treeConfig,l);f=function(d,e){if(e.$el.is(c.$el.selector))return b.stripNodePrefix(d.attr("id"))==j.ID};bu.hooks.addFilter("canSelectNode",f);bu.hooks.addFilter("canHoverNode",f);bu.hooks.addFilter("canDragNode",f);e.bind("reselect.jstree",function(){b.getNodeForPost(j)||"new"===j.status&&c.insertPost(j);0===e.jstree("get_selected").length&&(c.selectPost(j),c.save())});c.getCurrentPost=function(){var c;return(c=b.getNodeForPost(j))?c=b.nodeToPost(c):!1};c.setCurrentPost=function(b){j=
b};c.scrollToSelection=function(){var b=e.jstree("get_selected");if(b.length){d(document);e.css("overflow");var c=e.innerHeight(),b=b.position().top+b.height()/2-c/2;0<b&&e.scrollTop(b)}};e.addClass("bu-edit-post");return c}}})(jQuery);