var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(f){var p={listenFor:function(d,b){var c=this._listeners;void 0===c[d]&&(c[d]=[]);c[d].push(b)},broadcast:function(d,b){var c,f=this._listeners;if(f[d])for(c=0;c<f[d].length;c+=1)f[d][c].apply(this,b||[])}};bu.signals={register:function(d){d._listeners={};f.extend(!0,d,p)}};var m={};bu.hooks={addFilter:function(d,b){void 0===m[d]&&(m[d]=[]);m[d].push(b);return this},applyFilters:function(d,b){if(void 0===m[d])return b;var c=Array.prototype.slice.apply(arguments).slice(1),f=b,e;for(e=0;e<
m[d].length;e+=1)f=m[d][e].apply(this,c);return f}}})(jQuery);
(function(f){var p=bu.plugins.navigation;p.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0};f(document).ready(function(){!0===f.browser.msie&&7==parseInt(f.browser.version,10)&&f(document.body).addClass("ie7");!0===f.browser.msie&&8==parseInt(f.browser.version,10)&&f(document.body).addClass("ie8");!0===f.browser.msie&&9==parseInt(f.browser.version,10)&&f(document.body).addClass("ie9")});p.tree=function(f,d){"undefined"===typeof f&&(f="base");return p.trees[f](d).initialize()};
p.trees={base:function(m,d){var b={},d=d||{};bu.signals.register(b);b.config=f.extend({},p.settings,m||{});b.data={treeConfig:{},rollback:void 0};var c=b.config,h=b.data,e=b.$el=f(c.el);if(0===e.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");if(c.themePath&&document.images){var i=new Image,l=new Image;i.src=c.themePath+"/sprite.png";l.src=c.themePath+"/throbber.gif"}var i=function(a){return bu.hooks.applyFilters("canSelectNode",a,b)},l=function(a){return bu.hooks.applyFilters("canHoverNode",
a,b)},n=function(a){return bu.hooks.applyFilters("canDragNode",a,b)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:i,hover_node:l,start_drag:n},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:i,hover_node:l,start_drag:n},section:{max_children:-1,max_depth:-1,valid_children:"all",
select_node:i,hover_node:l,start_drag:n},link:{max_children:0,max_depth:0,valid_children:"none",select_node:i,hover_node:l,start_drag:n},denied:{select_node:!1,hover_node:!1,start_drag:!1}}},json_data:{ajax:{url:c.rpcUrl,type:"POST",data:function(a){return{child_of:a.attr?d.stripNodePrefix(a.attr("id")):0,post_types:c.postTypes,post_statuses:c.postStatuses,instance:c.instance,prefix:c.nodePrefix}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var g=d.nodeToPost(a.o),
f,q=!0;f=!1===g.meta.excluded||"link"===g.type;var j=!g.originalExclude&&(0===g.originalParent||"new"===g.status);-1===a.cr&&(!j&&f&&!c.allowTop)&&(q=!1);a.np.length&&a.np.attr("id")!==e.attr("id")&&(f=d.nodeToPost(a.np),"publish"==g.status&&"publish"!=f.status&&(q=!1));return bu.hooks.applyFilters("moveAllowed",q,a,b)}}},bu:{lazy_load:c.lazyLoad}};c.showCounts&&(h.treeConfig.json_data.progressive_render=!1);c.initialTreeData&&(h.treeConfig.json_data.data=c.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",
h.treeConfig,e);b.initialize=function(){e.jstree(h.treeConfig);return b};b.selectPost=function(a,g){var g=g||!0,b=d.getNodeForPost(a);g&&e.jstree("deselect_all");e.jstree("select_node",b)};b.getSelectedPost=function(){var a=e.jstree("get_selected");return a.length?d.nodeToPost(a):!1};b.deselectAll=function(){e.jstree("deselect_all")};b.getPost=function(a){return(a=d.getNodeForPost(a))?d.nodeToPost(a):!1};b.getPosts=function(a){var g=[],c={},q,j;(a?f.jstree._reference(e)._get_node("#"+a):e).find("> ul > li").each(function(a,
k){k=f(k);q=k.attr("id");j=k.data("post_type");"new"!=j&&(q=d.stripNodePrefix(q));c={ID:q,type:j,status:k.data("post_status"),title:e.jstree("get_text",k),content:k.data("post_content"),meta:k.data("post_meta")};k.find("> ul > li").length&&(c.children=b.getPosts(k.attr("id")));g.push(c)});return g};b.showAll=function(){e.jstree("open_all")};b.hideAll=function(){e.jstree("close_all")};b.getPostLabel=function(a){a=d.getNodeForPost(a);return e.jstree("get_text",a)};b.setPostLabel=function(a,g){var b=
d.getNodeForPost(a);e.jstree("set_text",b,g)};b.insertPost=function(a){var g,f;if("undefined"===typeof a)throw new TypeError("Post argument for insertPost must be defined!");var c,k;a.parent=a.parent||0;a.menu_order=a.menu_order||1;a.parent?(g=d.getNodeForPost(a.parent),c=b.getPost(a.parent)):g=e;1==a.menu_order?(f="before",g=g.find("> ul > li").get(0)):(k=a.menu_order-2,0<=k?(f="after",g=g.find("> ul > li").get(k)):(f="before",g=null));a=bu.hooks.applyFilters("preInsertPost",a,c);c=d.postToNode(a);
c=e.jstree("create",g,f,c,function(a){e.jstree("deselect_all");e.jstree("select_node",a)},!0);a.ID||(a.ID=c.attr("id"));return a};b.updatePost=function(a){var g=d.getNodeForPost(a),k;return g?(k=d.nodeToPost(g),a=f.extend(!0,{},k,a),e.jstree("set_text",g,a.title),g.data("post_content",a.content),g.data("post_title",a.title),g.data("post_status",a.status),g.data("post_type",a.type),g.data("post_parent",parseInt(a.parent,10)),g.data("menu_order",parseInt(a.menu_order,10)),g.data("post_meta",a.meta),
c.showStatuses&&g.find("li").andSelf().each(function(){r(f(this))}),b.broadcast("postUpdated",[a]),a):!1};b.removePost=function(a){a&&"undefined"===typeof a?(a=e.jstree("get_selected"),d.nodeToPost(a)):a=d.getNodeForPost(a);e.jstree("remove",a)};b.getAncestors=function(a){a=d.getNodeForPost(a);return e.jstree("get_path",a)};b.save=function(){h.rollback=e.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof h.rollback&&(f.jstree.rollback(h.rollback),h.rollback=e.jstree("get_rollback"))};
b.lock=function(){e.jstree("lock")};b.unlock=function(){e.jstree("unlock")};d.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var g=a.attr("id");-1===g.indexOf("post-new")&&(g=parseInt(d.stripNodePrefix(g),10));g={ID:g,title:e.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:a.index()+1,meta:a.data("post_meta")||{},originalParent:parseInt(a.data("originalParent"),
10),originalOrder:parseInt(a.data("originalOrder"),10),originalExclude:a.data("originalExclude"),inheritedExclusion:a.data("inheritedExclusion")||!1,inheritedRestriction:a.data("inheritedRestriction")||!1};return bu.hooks.applyFilters("nodeToPost",g,a)};d.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var g,a=f.extend({},{title:"(no title)",content:"",status:"new",type:"page",parent:0,menu_order:1,meta:{}},a);g=a.ID?c.nodePrefix+a.ID:"post-new-"+d.getNextPostID();
return bu.hooks.applyFilters("postToNode",{attr:{id:g,rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,post_parent:a.parent,menu_order:a.menu_order,post_meta:a.meta,originalParent:a.originalParent,originalOrder:a.originalOrder,originalExclude:a.originalExclude}},a)};d.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=c.nodePrefix+
a);a=f.jstree._reference(e)._get_node("#"+a);return a.length?a:!1};d.getNextPostID=function(){return f('[id*="post-new-"]').length};d.stripNodePrefix=function(a){return a.replace(c.nodePrefix,"")};var j=function(a,g){var b=a.find("li").length,d=a.children("a");0===d.children(".title-count").children(".count").length&&d.children(".title-count").append('<span class="count"></span>');d=d.find("> .title-count > .count").empty();b?d.text("("+b+")"):d.text("");g&&a.find("li").each(function(){j(f(this))})},
r=function(a){var b=a.children("a");0===b.children(".post-statuses").length&&b.append('<span class="post-statuses"></span>');d.nodeToPost(a);a.parentsUntil("#"+e.attr("id"),"li").filter(function(){return f(this).data("post_meta").excluded||f(this).data("inheritedExclusion")}).length?a.data("inheritedExclusion",!0):a.data("inheritedExclusion",!1);a.parentsUntil("#"+e.attr("id"),"li").filter(function(){return f(this).data("post_meta").restricted||f(this).data("inheritedRestriction")}).length?a.data("inheritedRestriction",
!0):a.data("inheritedRestriction",!1);var a=d.nodeToPost(a),c,k,j;k=a.meta.excluded||a.inheritedExclusion||!1;j=a.meta.restricted||a.inheritedRestriction||!1;b=b.children(".post-statuses").empty();c=[];"publish"!=a.status&&c.push({"class":a.status,label:a.status});k&&c.push({"class":"excluded",label:"not in nav"});j&&c.push({"class":"restricted",label:"restricted"});for(a=0;a<c.length;a+=1)b.append('<span class="post_status '+c[a]["class"]+'">'+c[a].label+"</span>")},k=function(a){0===a.children("ul").length?
a.attr("rel","page"):a.attr("rel","section");c.showCounts&&(a=a.parent("ul").parent("div").attr("id")!=e.attr("id")?a.parents("li:last"):a,j(a,!0))};e.bind("loaded.jstree",function(){var a=e.find("> ul > li:first-child"),a=18<=a.height()?a.height():32;e.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});e.bind("reselect.jstree",function(){b.broadcast("postsSelected")});e.bind("lazy_loaded.jstree",function(){b.broadcast("lazyLoadComplete")});e.bind("load_node.jstree",function(a,b){if(-1!==
b.rslt.obj){var d=b.rslt.obj;c.showCounts&&j(d,!0)}});e.bind("clean_node.jstree",function(a,b){var d=b.rslt.obj;d&&-1!==d&&d.each(function(a,b){var d=f(b);d.data("bu-nav-extras-added")||(c.showStatuses&&r(d),d.data("bu-nav-extras-added",!0))})});e.bind("create_node.jstree",function(a,g){var c=d.nodeToPost(g.rslt.obj);b.broadcast("postCreated",[c])});e.bind("select_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("postSelected",[e])});e.bind("create.jstree",function(a,c){var e=
c.rslt.parent,f=c.rslt.position,j=d.nodeToPost(c.rslt.obj),h=null;-1!==e&&(h=d.nodeToPost(e),k(e));j.parent=h?h.ID:0;j.menu_order=f+1;b.broadcast("postInserted",[j])});e.bind("remove.jstree",function(a,c){var e=c.rslt.obj,j=d.nodeToPost(e),h=c.rslt.parent,i;-1!==h&&k(h);b.broadcast("postRemoved",[j]);e.find("li").each(function(){(i=d.nodeToPost(f(this)))&&b.broadcast("postRemoved",[i])})});e.bind("deselect_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("postDeselected",[e])});
e.bind("deselect_all.jstree",function(){b.broadcast("postsDeselected")});e.bind("move_node.jstree",function(a,c){c.rslt.o.each(function(a,j){var h=f(j),i=d.nodeToPost(h),l=c.rslt.np,m=c.rslt.op,h=h.index()+1,n=0,p=0,r=1;e.attr("id")!==l.attr("id")&&(k(l),n=parseInt(d.stripNodePrefix(l.attr("id")),10));e.attr("id")!==m.attr("id")&&!l.is("#"+m.attr("id"))&&(k(m),l=d.nodeToPost(m),p=l.ID);r=i.menu_order;i.parent=n;i.menu_order=h;b.updatePost(i);b.broadcast("postMoved",[i,p,r])})});i=function(a){var b=
f.contains(e[0],a.target),a=f.contains(f("#vakata-contextmenu")[0],a.target);!b&&!a&&e.jstree("deselect_all")};c.deselectOnDocumentClick&&f(document).bind("click",i);return b},navman:function(m,d){var b={},d=d||{},b=p.trees.base(m,d),c=b.$el,h=b.data;h.treeConfig.plugins.push("contextmenu");h.treeConfig.contextmenu={show_at_node:!1,items:function(b){return bu.hooks.applyFilters("navmanContextItems",{edit:{label:"Edit",action:e,icon:"remove"},remove:{label:"Move to Trash",action:i}},b)}};var e=function(c){c=
d.nodeToPost(c);b.broadcast("editPost",[c])},i=function(c){c=d.nodeToPost(c);b.removePost(c)};c.bind("loaded.jstree",function(){c.undelegate("a","contextmenu.jstree")});c.bind("clean_node.jstree",function(b,c){var d=c.rslt.obj;d&&-1!=d&&d.each(function(a,b){var c=f(b).children("a");if(!c.children(".edit-options").length){var d=f('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),e=c.children(".post-statuses");e.length?e.before(d):c.append(d)}})});var l=null;c.delegate(".edit-options",
"click",function(b){b.preventDefault();b.stopPropagation();var b=f(this).offset(),d=f(this).height()+5,e=f(this).parent("a").parent("li");c.jstree("deselect_all");f(this).addClass("clicked");c.jstree("select_node",e);c.jstree("show_contextmenu",e,b.left,b.top+d);l&&l.attr("id")!=e.attr("id")&&n(l);l=e});f(document).bind("context_hide.vakata",function(){n(l)});var n=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};c.addClass("bu-navman");return b},edit_post:function(m,d){var d=
d||{},b=p.trees.base(m,d),c=b.data,h=f.extend(b.config,m||{}),e=b.$el,i=h.currentPost,l={},n=[],j;if(h.ancestors&&h.ancestors.length){var r=h.ancestors.reverse();for(j=0;j<r.length;j+=1)n.push("#"+h.nodePrefix+h.ancestors[j])}n.length&&(l.core={initially_open:n});f.extend(!0,c.treeConfig,l);c=function(c,a){if(a.$el.is(b.$el.selector))return d.stripNodePrefix(c.attr("id"))==i.ID};bu.hooks.addFilter("canSelectNode",c);bu.hooks.addFilter("canHoverNode",c);bu.hooks.addFilter("canDragNode",c);e.bind("reselect.jstree",
function(){d.getNodeForPost(i)||b.insertPost(i);0===e.jstree("get_selected").length&&(b.selectPost(i),b.save())});b.getCurrentPost=function(){var b;return(b=d.getNodeForPost(i))?b=d.nodeToPost(b):!1};b.setCurrentPost=function(b){i=b};b.scrollToSelection=function(){var b=e.jstree("get_selected");if(b.length){f(document);e.css("overflow");var a=e.innerHeight(),b=b.position().top+b.height()/2-a/2;0<b&&e.scrollTop(b)}};e.addClass("bu-edit-post");return b}}})(jQuery);