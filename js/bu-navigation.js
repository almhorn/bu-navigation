var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var c={},j=this;return{listenFor:function(g,d){"undefined"===typeof c[g]&&(c[g]=[]);c[g].push(d);return j},broadcast:function(g,d){if(c[g])for(var b=0;b<c[g].length;b++)c[g][b].apply(this,d||[]);return j}}}();bu.hooks=function(){var c={},j=this;return{addFilter:function(g,d){"undefined"===typeof c[g]&&(c[g]=[]);c[g].push(d);return j},applyFilters:function(g,d){if("undefined"===typeof c[g])return d;extra=Array.prototype.slice.apply(arguments).slice(1);for(var b=0,
b=0;b<c[g].length;b++)d=c[g][b].apply(this,extra);return d}}}()})(jQuery);
(function(c){var j=bu.plugins.navigation;j.settings=buNavSettings||{};j.tree=function(c,d){"undefined"===typeof c&&(c="base");return j.trees[c](d).initialize()};j.trees={base:function(g,d){var b={},d=d||{};c.extend(!0,b,bu.signals);b.config=c.extend({},{el:"#navman_container",nodePrefix:"p"},g||{});b.data={treeConfig:{},rollback:void 0};var h=j.settings,k=b.config,l=b.data,e=b.$el=c(k.el);if(0===e.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");l.treeConfig={plugins:"themes types json_data ui dnd crrm".split(" "),
core:{animation:0,html_titles:!0},themes:{theme:"bu",url:h.themePath+"/style.css"},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",icon:{image:h.themePath+"/icons/page_regular.png"}},page:{max_children:-1,max_depth:-1,valid_children:"all",icon:{image:h.themePath+"/icons/page_regular.png"}},section:{max_children:-1,max_depth:-1,valid_children:"all",icon:{image:h.themePath+"/icons/page_regular.png"}},link:{max_children:0,max_depth:0,valid_children:"none",icon:{image:h.themePath+
"/icons/page_link.png"}}}},json_data:{data:h.initialTreeData,ajax:{url:h.rpcUrl,type:"POST",data:function(a){return{id:a.attr?a.attr("id"):0}}},progressive_render:!1},crrm:{move:{check_move:n}}};b.initialize=function(){e.jstree(l.treeConfig);return b};b.selectPost=function(a){a=d.getNodeForPost(a);e.jstree("select_node",a)};b.getSelected=function(){var a=e.jstree("get_selected");return d.nodeToPost(a)};b.getPosts=function(){return e.jstree("get_json",-1)};b.showAll=function(){e.jstree("open_all")};
b.hideAll=function(){e.jstree("close_all")};b.insertPost=function(a,i){var f=c.extend({position:"after",which:null,skip_rename:!0,callback:null},i),g=d.postToNode(a);e.jstree("create",f.which,f.position,g,f.callback,f.skip_rename);b.broadcast("insertPost",[a]);return g.attr.id};b.updatePost=function(a){var i=d.getNodeForPost(a);i&&(e.jstree("set_text",i,a.title),i.data("post_content",a.content),i.data("post_title",a.title),i.data("post_status",a.status),i.data("post_type",a.type),i.data("post_parent",
a.parent),i.data("menu_order",a.menu_order),i.data("post_meta",a.meta));b.broadcast("updatePost",[a])};b.removePost=function(a){var i;a&&"undefined"===typeof a?(i=e.jstree("get_selected"),a=d.nodeToPost(i)):i=d.getNodeForPost(a);e.jstree("remove",i);b.broadcast("removePost",[a])};b.getAncestors=function(a){a=d.getNodeForPost(a);return e.jstree("get_path",a)};b.save=function(){l.rollback=e.jstree("get_rollback")};b.restore=function(){l.rollback.d.ui.selected=c([]);c.jstree.rollback(l.rollback)};d.nodeToPost=
function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var b=a.attr("id");-1===b.indexOf("post-new")&&(b=d.stripNodePrefix(b));a={ID:b,title:e.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:a.data("post_parent"),menu_order:a.data("menu_order"),meta:a.data("post_meta")||{}};return bu.hooks.applyFilters("nodeToPost",a)};d.postToNode=function(a,b){if("undefined"===typeof a)throw new TypeError("Invalid post!");c.extend({},
{hasChildren:!1,parentId:0},b||{});var f={ID:d.getNextPostID(),title:"Untitled Post",content:"",status:"new",type:"page",parent:0,menu_order:0,meta:{}},f=c.extend({},f,a);return bu.hooks.applyFilters("postToNode",{attr:{id:f.ID?k.nodePrefix+f.ID:"post-new-"+f.ID,rel:f.type},data:{title:f.title},metadata:{post_status:f.status,post_type:f.type,post_content:f.content,post_meta:f.meta}})};d.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?
a.ID:a;-1===a.indexOf("post-new")&&(a=k.nodePrefix+a);a=c.jstree._reference(e)._get_node("#"+a);return a.length?a:!1};d.getNextPostID=function(){return c('[id*="post-new-"]').length};d.stripNodePrefix=function(a){return a.replace(k.nodePrefix,"")};var m=function(a,b){"undefined"===typeof countChildren&&(countChildren=!0);var d=a.find("li").length;$a=a.children("a");d?($count=$a.children(".count"),0===$count.length&&($statuses=$a.children(".post-statuses"),$count=c(' <span class="count">'),$statuses.length?
$statuses.before($count):$a.append($count)),$count.text("("+d+")")):$a.children(".count").remove();b&&a.find("> ul > li").each(function(){m(c(this))})},n=function(a){a.np.attr("id");var b=!0;-1===a.cr&&!j.settings.allowTop&&(b=!1);return bu.hooks.applyFilters("moveAllowed",b,a)};e.bind("loaded.jstree",function(){h.lazyLoad&&(!0===c.browser.msie&&8>parseInt(c.browser.version,10)||e.find("ul > .jstree-closed").each(function(){var a=c(this);e.jstree("load_node",a,function(){},function(){})}));b.broadcast("postsLoaded")});
e.bind("reselect.jstree",function(){b.broadcast("postsSelected")});e.bind("load_node.jstree",function(a,b){-1!==b.rslt.obj&&m(b.rslt.obj)});e.bind("clean_node.jstree",function(a,b){var d=b.rslt.obj;d&&-1!==d&&d.each(function(a,b){var d=c(b);if(0===d.find("> a .post-statuses").length){var e=d.data("post_status")||"publish";$a=d.children("a");0===$a.children("post-statuses").length&&$a.append(' <span class="post-statuses">');"publish"!=e&&$a.children(".post-statuses").append(' <span class="post_status '+
e+'">'+e+"</span>")}})});e.bind("create_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("postCreated",[e])});e.bind("select_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("selectPost",[e,b])});e.bind("deselect_node.jstree",function(a,c){var e=d.nodeToPost(c.rslt.obj);b.broadcast("deselectPost",[e,b])});e.bind("move_node.jstree",function(a,c){var f=c.rslt.np,g=c.rslt.op,h=c.rslt.o.index()+1,j;j=e.attr("id")==f.attr("id")?0:parseInt(d.stripNodePrefix(f.attr("id")),
10);$newsection=f.parentsUntil(e,"li");$oldsection=g.parentsUntil(e,"li");$newsection=$newsection.length?$newsection.last():f;$oldsection=$oldsection.length?$oldsection.last():g;$oldsection.is($newsection)||m($oldsection);m($newsection);f=d.nodeToPost(c.rslt.o);f.parent=j;f.menu_order=h;b.updatePost(f);b.broadcast("postMoved",[f,j,h])});c(document).bind("mousedown",function(a){c.contains(e.jstree("get_selected"),a.target)||e.jstree("deselect_all")});c(document).bind("drag_start.vakata",function(a,
b){b.data.obj.addClass("bu-dnd-placeholder")});c(document).bind("drag_stop.vakata",function(a,b){b.data.obj.removeClass("bu-dnd-placeholder")});return b},navman:function(g,d){var b={},d=d||{},b=j.trees.base(g,d),h=b.$el,k=b.data;k.treeConfig.plugins.push("contextmenu");k.treeConfig.contextmenu={show_at_node:!1,items:function(){return{edit:{label:"Edit",action:l,icon:"remove"},remove:{label:"Remove",action:e}}}};var l=function(c){c=d.nodeToPost(c);b.broadcast("editPost",[c])},e=function(c){c=d.nodeToPost(c);
b.removePost(c)};h.bind("loaded.jstree",function(){h.undelegate("a","contextmenu.jstree")});h.bind("clean_node.jstree",function(b,d){var a=d.rslt.obj;a&&-1!=a&&a.each(function(a,b){var d=c(b).children("a");d.children(".edit-options").length||d.append('<button class="edit-options">Options</button>')})});h.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();h.jstree("deselect_all");var b=c(this).offset(),d=c(this).height()+5,a=c(this).parent("a").parent("li");h.jstree("select_node",
a);h.jstree("show_contextmenu",a,b.left,b.top+d)});return b},edit_post:function(g,d){var d=d||{},b=j.trees.base(g,d),h=b.data,k=c.extend(b.config,g||{}),l=j.settings,e=l.currentPost,m=k.nodePrefix+e,n={types:{types:{}}},a=[],i=[],f;if(e&&(a.push("#"+m),l.ancestors&&l.ancestors.length)){var p=l.ancestors.reverse();for(f=0;f<p.length;f++)i.push("#"+k.nodePrefix+l.ancestors[f])}a.length&&(n.ui={initially_select:a});i.length&&(n.core={initially_open:i});var k=function(a){return d.nodeToPost(a).ID==e},
q={select_node:k,hover_node:k,start_drag:k};c.each(h.treeConfig.types.types,function(a,b){n.types.types[a]=c.extend(b,q)});c.extend(!0,h.treeConfig,n);b.getCurrentPost=function(){if(null===e||"undefined"===typeof e)return!1;var a=d.getNodeForPost(e);return d.nodeToPost(a)};b.setCurrentPost=function(a){var c=d.getNodeForPost(a);e=a.ID;m=c.attr("id");b.selectPost(a)};return b}}})(jQuery);