var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var a={},f=this;return{listenFor:function(i,c){"undefined"===typeof a[i]&&(a[i]=[]);a[i].push(c);return f},broadcast:function(i,c){if(a[i])for(var b=0;b<a[i].length;b++)a[i][b].apply(this,c||[]);return f}}}();bu.hooks=function(){var a={},f=this;return{addFilter:function(i,c){"undefined"===typeof a[i]&&(a[i]=[]);a[i].push(c);return f},applyFilters:function(f,c){if("undefined"===typeof a[f])return c;extra=Array.prototype.slice.apply(arguments).slice(1);for(var b=0,
b=0;b<a[f].length;b++)c=a[f][b].apply(this,extra);return c}}}()})(jQuery);
(function(a){a.jstree.plugin("bu",{defaults:{drop_target:null,placeholder_class:"bu-dnd-placeholder",target_class:"bu-dnd-target"},__init:function(){if(!this.data.dnd)throw"BU jstree plugin is dependent on the dnd plugin.";this.data.bu.drop_target=null;var f=this._get_settings().bu;this.get_container().bind("mouseenter.jstree",a.proxy(function(){a.vakata.dnd.is_drag&&a.vakata.dnd.user_data.jstree&&this._bu_dnd_update_state()},this)).bind("mouseleave.jstree",a.proxy(function(){a.vakata.dnd.is_drag&&
a.vakata.dnd.user_data.jstree&&this._bu_dnd_update_state()},this)).delegate("a","mouseleave.jstree",a.proxy(function(){a.vakata.dnd.is_drag&&a.vakata.dnd.user_data.jstree&&this.data.bu.drop_target&&(this.data.bu.drop_target.removeClass(f.target_class),this.data.bu.drop_target=null)},this));a(document).bind("drag_start.vakata",a.proxy(function(i,c){var b=c.data.obj;b.addClass(f.placeholder_class);a.vakata.dnd.helper.width(b.width())},this)).bind("drag_stop.vakata",a.proxy(function(a,c){c.data.obj.removeClass(f.placeholder_class)},
this))},_fn:{dnd_enter:function(a){this.__call_old();if(a=this._get_node(a))this.data.bu.drop_target=a.children("a");this.__callback({target:a})},dnd_show:function(){var a=this.__call_old(),i=this._get_settings().bu;this.data.bu.drop_target&&("inside"===a?this.data.bu.drop_target.addClass(i.target_class):this.data.bu.drop_target.removeClass(i.target_class));this._bu_dnd_update_state();this.__callback({position:a});return a},dnd_leave:function(f){this.__call_old();this._bu_dnd_update_state();this.__callback({leaving:a(f.target.parentNode)})},
dnd_finish:function(){this.__call_old();var a=this._get_settings().bu;this.data.bu.drop_target&&(this.data.bu.drop_target.removeClass(a.target_class),this.data.bu.drop_target=null);this.__callback()},_bu_dnd_update_state:function(){a.vakata.dnd.helper&&(a.vakata.dnd.helper.removeClass("jstree-ok jstree-invalid"),a.vakata.dnd.helper.addClass(a.vakata.dnd.helper.children("ins").attr("class")))}}})})(jQuery);
(function(a){var f=bu.plugins.navigation;f.settings=buNavSettings||{};f.tree=function(a,c){"undefined"===typeof a&&(a="base");return f.trees[a](c).initialize()};f.trees={base:function(i,c){var b={},c=c||{};a.extend(!0,b,bu.signals);b.config=a.extend({},{el:"#nav-tree-container",nodePrefix:f.settings.nodePrefix},i||{});b.data={treeConfig:{},rollback:void 0};var h=f.settings,l=b.config,k=b.data,e=b.$el=a(l.el);if(0===e.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");
k.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!1},themes:{theme:"bu",url:h.themePath+"/style.css"},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all"},page:{max_children:-1,max_depth:-1,valid_children:"all"},section:{max_children:-1,max_depth:-1,valid_children:"all"},link:{max_children:0,max_depth:0,valid_children:"none"}}},json_data:{ajax:{url:h.rpcUrl,type:"POST",data:function(d){return{id:d.attr?c.stripNodePrefix(d.attr("id")):
0}}},progressive_render:!0},crrm:{move:{check_move:function(d){d.np.attr("id");var a=!0;-1===d.cr&&!f.settings.allowTop&&(a=!1);return bu.hooks.applyFilters("moveAllowed",a,d)}}}};h.showCounts&&(k.treeConfig.json_data.progressive_render=!1);h.initialTreeData&&(k.treeConfig.json_data.data=h.initialTreeData);b.initialize=function(){e.jstree(k.treeConfig);return b};b.selectPost=function(d){d=c.getNodeForPost(d);e.jstree("select_node",d)};b.getSelected=function(){var d=e.jstree("get_selected");return c.nodeToPost(d)};
b.getPosts=function(){return e.jstree("get_json",-1)};b.showAll=function(){e.jstree("open_all")};b.hideAll=function(){e.jstree("close_all")};b.getPostLabel=function(d){d=c.getNodeForPost(d);return e.jstree("get_text",d)};b.setPostLabel=function(d,a){var b=c.getNodeForPost(d);e.jstree("set_text",b,a)};b.insertPost=function(d,j){var g=a.extend({position:"after",which:null,skip_rename:!0,callback:null},j),f=c.postToNode(d);e.jstree("create",g.which,g.position,f,g.callback,g.skip_rename);d.ID=c.stripNodePrefix(f.attr.id);
b.broadcast("insertPost",[d]);return d};b.updatePost=function(d){var j=c.getNodeForPost(d);j&&(origPost=c.nodeToPost(j),updated=a.extend(!0,{},origPost,d),e.jstree("set_text",j,updated.title),j.data("post_content",updated.content),j.data("post_title",updated.title),j.data("post_status",updated.status),j.data("post_type",updated.type),j.data("post_parent",updated.parent),j.data("menu_order",updated.menu_order),j.data("post_meta",updated.meta));b.broadcast("updatePost",[updated]);return updated};b.removePost=
function(d){var a;d&&"undefined"===typeof d?(a=e.jstree("get_selected"),d=c.nodeToPost(a)):a=c.getNodeForPost(d);e.jstree("remove",a);b.broadcast("removePost",[d])};b.getAncestors=function(d){d=c.getNodeForPost(d);return e.jstree("get_path",d)};b.save=function(){k.rollback=e.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof k.rollback&&(k.rollback.d.ui.selected=a([]),a.jstree.rollback(k.rollback))};c.nodeToPost=function(d){if("undefined"===typeof d)throw new TypeError("Invalid node!");
var a=d.attr("id");-1===a.indexOf("post-new")&&(a=c.stripNodePrefix(a));d={ID:a,title:e.jstree("get_text",d),content:d.data("post_content"),status:d.data("post_status"),type:d.data("post_type"),parent:d.data("post_parent"),menu_order:d.data("menu_order"),meta:d.data("post_meta")||{}};return bu.hooks.applyFilters("nodeToPost",d)};c.postToNode=function(d,b){if("undefined"===typeof d)throw new TypeError("Invalid post!");a.extend({},{hasChildren:!1,parentId:0},b||{});var g={ID:c.getNextPostID(),title:"Untitled Post",
content:"",status:"new",type:"page",parent:0,menu_order:0,meta:{}},g=a.extend({},g,d);return bu.hooks.applyFilters("postToNode",{attr:{id:g.ID?l.nodePrefix+g.ID:"post-new-"+g.ID,rel:g.type},data:{title:g.title},metadata:{post_status:g.status,post_type:g.type,post_content:g.content,post_meta:g.meta}})};c.getNodeForPost=function(d){if("undefined"===typeof d)throw new TypeError("Invalid post!");d=d&&"object"===typeof d?d.ID:d;-1===d.indexOf("post-new")&&(d=l.nodePrefix+d);d=a.jstree._reference(e)._get_node("#"+
d);return d.length?d:!1};c.getNextPostID=function(){return a('[id*="post-new-"]').length};c.stripNodePrefix=function(a){return a.replace(l.nodePrefix,"")};var m=function(d,b){"undefined"===typeof b&&(b=!0);var c=d.find("li").length,e=d.children("a");if(c){var f=e.children(".count");if(0===f.length){var h=e.children(".edit-options"),f=a(' <span class="count">');h.length?h.before(f):e.append(f)}f.text("("+c+")")}else e.children(".count").remove();b&&d.find("> ul > li").each(function(){m(a(this))})};
e.bind("loaded.jstree",function(){b.broadcast("postsLoaded")});e.bind("reselect.jstree",function(){h.lazyLoad&&(!0===a.browser.msie&&8>parseInt(a.browser.version,10)||e.find("ul > .jstree-closed").each(function(){var d=a(this);e.jstree("load_node",d,function(){},function(){})}));b.broadcast("postsSelected")});e.bind("load_node.jstree",function(a,b){if(-1!==b.rslt.obj){var c=b.rslt.obj;h.showCounts&&m(c)}});e.bind("clean_node.jstree",function(d,b){var c=b.rslt.obj;c&&-1!==c&&c.each(function(d,b){var c=
a(b);if(0===c.find("> a > .post-statuses").length){var e=c.children("a");0===e.children("post-statuses").length&&e.append(' <span class="post-statuses">');var j=c.data("post_status")||"publish",g=c.data("excluded")||null,c=c.data("restricted")||null,e=e.children(".post-statuses"),f=[];"publish"!=j&&f.push({"class":j,label:j});c&&f.push({"class":"restricted",label:"restricted"});g&&f.push({"class":"excluded",label:"not in nav"});f=bu.hooks.applyFilters("navPostStatuses",f);for(j=0;j<f.length;j++)e.append('<span class="post_status '+
f[j]["class"]+'">'+f[j].label+"</span>")}})});e.bind("create_node.jstree",function(a,e){var f=c.nodeToPost(e.rslt.obj);b.broadcast("postCreated",[f])});e.bind("select_node.jstree",function(a,e){var f=c.nodeToPost(e.rslt.obj);b.broadcast("selectPost",[f,b])});e.bind("deselect_node.jstree",function(a,e){var f=c.nodeToPost(e.rslt.obj);b.broadcast("deselectPost",[f,b])});e.bind("move_node.jstree",function(a,f){var g=f.rslt.np,h=f.rslt.op,i=f.rslt.o.index()+1,k;k=e.attr("id")==g.attr("id")?0:parseInt(c.stripNodePrefix(g.attr("id")),
10);$newsection=g.parentsUntil(e,"li");$oldsection=h.parentsUntil(e,"li");$newsection=$newsection.length?$newsection.last():g;$oldsection=$oldsection.length?$oldsection.last():h;$oldsection.is($newsection)||m($oldsection);m($newsection);g=c.nodeToPost(f.rslt.o);g.parent=k;g.menu_order=i;b.updatePost(g);b.broadcast("postMoved",[g,k,i])});return b},navman:function(i,c){var b={},c=c||{},b=f.trees.base(i,c),h=b.$el,l=b.data;l.treeConfig.plugins.push("contextmenu");l.treeConfig.contextmenu={show_at_node:!1,
items:function(){return{edit:{label:"Edit",action:k,icon:"remove"},remove:{label:"Remove",action:e}}}};var k=function(a){a=c.nodeToPost(a);b.broadcast("editPost",[a])},e=function(a){a=c.nodeToPost(a);b.removePost(a)};h.bind("loaded.jstree",function(){h.undelegate("a","contextmenu.jstree")});h.bind("clean_node.jstree",function(b,d){var c=d.rslt.obj;c&&-1!=c&&c.each(function(d,c){var b=a(c).children("a");if(!b.children(".edit-options").length){var e=a('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),
f=b.children(".post-statuses");f.length?f.before(e):b.append(e)}})});h.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();h.jstree("deselect_all");var b=a(this).offset(),d=a(this).height()+5,c=a(this).parent("a").parent("li");a(this).addClass("clicked");h.jstree("select_node",c);h.jstree("show_contextmenu",c,b.left,b.top+d)});h.bind("deselect_all.jstree",function(a,b){var c=b.rslt.obj;c.attr("id")!==h.attr("id")&&c.find("> a > .edit-options").removeClass("clicked")});
a(document).bind("mousedown",function(a){0===h.jstree("get_selected",h).filter(a.target).length&&h.jstree("deselect_all")});return b},edit_post:function(i,c){var c=c||{},b=f.trees.base(i,c),h=b.data,l=a.extend(b.config,i||{}),k=f.settings,e=k.currentPost,m=l.nodePrefix+e,d={types:{types:{}}},j=[],g=[],n;if(e&&(j.push("#"+m),k.ancestors&&k.ancestors.length)){var p=k.ancestors.reverse();for(n=0;n<p.length;n++)g.push("#"+l.nodePrefix+k.ancestors[n])}j.length&&(d.ui={initially_select:j});g.length&&(d.core=
{initially_open:g});var l=function(a){return c.nodeToPost(a).ID==e},q={select_node:l,hover_node:l,start_drag:l};a.each(h.treeConfig.types.types,function(b,c){d.types.types[b]=a.extend(c,q)});a.extend(!0,h.treeConfig,d);b.getCurrentPost=function(){if(null===e||"undefined"===typeof e)return!1;var a=c.getNodeForPost(e);return c.nodeToPost(a)};b.setCurrentPost=function(a){var d=c.getNodeForPost(a);e=a.ID;m=d.attr("id");b.selectPost(a)};return b}}})(jQuery);