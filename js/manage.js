if("undefined"===typeof bu||"undefined"===typeof bu.plugins.navigation||"undefined"===typeof bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");
(function(b){bu.plugins.navigation.views=bu.plugins.navigation.views||{};var f,c,d;f=bu.plugins.navigation.views.Navman={el:"#nav-tree-container",ui:{form:"#navman_form",movesField:"#navman-moves",insertsField:"#navman-inserts",updatesField:"#navman-updates",deletionsField:"#navman-deletions",expandAllBtn:"#navman_expand_all",collapseAllBtn:"#navman_collapse_all",container:"#navman-body"},data:{dirty:!1,deletions:[],insertions:{},updates:{},moves:{}},initialize:function(){var a=bu_navman_settings;
a.el=this.el;d=bu.plugins.navigation.tree("navman",a);c.initialize();d.listenFor("editPost",b.proxy(this.editPost,this));d.listenFor("postRemoved",b.proxy(this.postRemoved,this));d.listenFor("postMoved",b.proxy(this.postMoved,this));c.listenFor("linkInserted",b.proxy(this.linkInserted,this));c.listenFor("linkUpdated",b.proxy(this.linkUpdated,this));b(this.ui.form).bind("submit",b.proxy(this.save,this));b(this.ui.expandAllBtn).bind("click",this.expandAll);b(this.ui.collapseAllBtn).bind("click",this.collapseAll)},
expandAll:function(a){a.preventDefault();a.stopImmediatePropagation();d.showAll()},collapseAll:function(a){a.preventDefault();a.stopImmediatePropagation();d.hideAll()},editPost:function(a){"link"==a.type?c.edit(a):window.location="post.php?action=edit&post="+a.ID},linkInserted:function(a){this.data.insertions[a.ID]=a;this.data.dirty=!0},linkUpdated:function(a){"new"===a.status?this.data.insertions[a.ID]=a:this.data.updates[a.ID]=a;this.data.dirty=!0},postRemoved:function(a){if(a=a.ID)"undefined"!==
typeof this.data.insertions[a]?delete this.data.insertions[a]:("undefined"!==typeof this.data.updates[a]?delete this.data.updates[a]:"undefined"!==typeof this.data.moves[a]&&delete this.data.moves[a],this.data.deletions.push(a),this.data.dirty=!0)},postMoved:function(a){if("new"!=a.status&&(a.parent!=a.originalParent||a.menu_order!=a.originalOrder))this.data.moves[a.ID]=a,this.data.dirty=!0},save:function(){var a=this.data.deletions,g={},c={},f={},e;b.each(this.data.insertions,function(a){(e=d.getPost(a))&&
(f[e.ID]=e)});b.each(this.data.updates,function(a){(e=d.getPost(a))&&(c[e.ID]=e)});b.each(this.data.moves,function(a){(e=d.getPost(a))&&(g[e.ID]=e)});b(this.ui.deletionsField).attr("value",JSON.stringify(a));b(this.ui.insertsField).attr("value",JSON.stringify(f));b(this.ui.updatesField).attr("value",JSON.stringify(c));b(this.ui.movesField).attr("value",JSON.stringify(g));this.data.dirty=!1}};c=bu.plugins.navigation.views.Linkman={el:"#navman-link-editor",ui:{form:"#navman_editlink_form",addBtn:"#navman_add_link",
urlField:"#editlink_address",labelField:"#editlink_label",targetNewField:"#editlink_target_new",targetSameField:"#editlink_target_same"},data:{currentLink:null},initialize:function(){b.extend(!0,this,bu.signals);this.$el=b(this.el);this.$form=b(this.ui.form);this.$el.dialog({autoOpen:!1,buttons:{Ok:b.proxy(this.save,this),Cancel:b.proxy(this.cancel,this)},minWidth:400,width:500,modal:!0,resizable:!1});b(document.body).delegate(".ui-widget-overlay, .ui-widget","click",this.stopPropagation);b(this.ui.addBtn).bind("click",
b.proxy(this.add,this));return this},add:function(a){a.preventDefault();a.stopPropagation();this.data.currentLink={status:"new",type:"link",meta:{}};this.$el.dialog("option","title","Add a Link").dialog("open")},edit:function(a){b(this.ui.urlField).attr("value",a.content);b(this.ui.labelField).attr("value",a.title);"new"==a.meta.bu_link_target?b(this.ui.targetNewField).attr("checked","checked"):b(this.ui.targetSameField).attr("checked","checked");this.data.currentLink=a;this.$el.dialog("option","title",
"Edit a Link").dialog("open")},save:function(a){a.preventDefault();a.stopPropagation();if(this.$form.valid()){a=this.data.currentLink;a.content=b(this.ui.urlField).attr("value");a.title=b(this.ui.labelField).attr("value");a.meta.bu_link_target=b("input[name='editlink_target']:checked").attr("value");var c=d.getSelectedPost();c?(a.parent=c.parent,a.menu_order=c.menu_order+1):(a.parent=0,a.menu_order=1);"new"===a.status&&!a.ID?(a=d.insertPost(a),this.broadcast("linkInserted",[a])):(a=d.updatePost(a),
this.broadcast("linkUpdated",[a]));this.clear();this.$el.dialog("close")}},cancel:function(a){a.preventDefault();a.stopPropagation();this.$el.dialog("close");this.clear()},clear:function(){b(this.ui.urlField).attr("value","");b(this.ui.labelField).attr("value","");b(this.ui.targetSameField).attr("checked","checked");b(this.ui.targetNewField).removeAttr("checked");this.data.currentLink=null},stopPropagation:function(a){a.stopPropagation()}};window.onbeforeunload=function(){if(f.data.dirty)return"You have made changes to your navigation that have not yet been saved."}})(jQuery);
jQuery(document).ready(function(){bu.plugins.navigation.views.Navman.initialize()});