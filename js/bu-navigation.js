var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(g){var r={listenFor:function(c,b){var e=this._listeners;void 0===e[c]&&(e[c]=[]);e[c].push(b)},broadcast:function(c,b){var e,g=this._listeners;if(g[c])for(e=0;e<g[c].length;e+=1)g[c][e].apply(this,b||[])}};bu.signals={register:function(c){c._listeners={};g.extend(!0,c,r)}};var m={};bu.hooks={addFilter:function(c,b){void 0===m[c]&&(m[c]=[]);m[c].push(b);return this},applyFilters:function(c,b){if(void 0===m[c])return b;var e=Array.prototype.slice.apply(arguments).slice(1),g=b,d;for(d=0;d<
m[c].length;d+=1)g=m[c][d].apply(this,e);return g}}})(jQuery);
(function(g){var r=bu.plugins.navigation;r.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0};g(document).ready(function(){!0===g.browser.msie&&7==parseInt(g.browser.version,10)&&g(document.body).addClass("ie7");!0===g.browser.msie&&8==parseInt(g.browser.version,10)&&g(document.body).addClass("ie8");!0===g.browser.msie&&9==parseInt(g.browser.version,10)&&g(document.body).addClass("ie9")});r.tree=function(g,c){"undefined"===typeof g&&(g="base");return r.trees[g](c).initialize()};
r.trees={base:function(m,c){var b={},c=c||{};bu.signals.register(b);b.config=g.extend({},r.settings,m||{});b.data={treeConfig:{},rollback:void 0};var e=b.config,h=b.data,d=b.$el=g(e.el);if(e.themePath&&document.images){var j=new Image,p=new Image;j.src=e.themePath+"/sprite.png";p.src=e.themePath+"/throbber.gif"}var j=function(a){return bu.hooks.applyFilters("canSelectNode",a,b)},p=function(a){return bu.hooks.applyFilters("canHoverNode",a,b)},k=function(a){return bu.hooks.applyFilters("canDragNode",
a,b)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:p,start_drag:k},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:p,start_drag:k},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:j,hover_node:p,start_drag:k},link:{max_children:0,
max_depth:0,valid_children:"none",select_node:j,hover_node:p,start_drag:k}}},json_data:{ajax:{url:e.rpcUrl,type:"POST",data:function(a){return{child_of:a.attr?c.stripNodePrefix(a.attr("id")):0,post_types:e.postTypes,post_statuses:e.postStatuses,instance:e.instance,prefix:e.nodePrefix}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var f=c.nodeToPost(a.o),q,g=!0;q=!1===f.meta.excluded||"link"===f.type;var i=!f.originalExclude&&(0===f.originalParent||"new"===f.status);
-1===a.cr&&(!i&&q&&!e.allowTop)&&(g=!1);a.np.length&&a.np.attr("id")!==d.attr("id")&&(q=c.nodeToPost(a.np),"publish"==f.status&&"publish"!=q.status&&(g=!1));return bu.hooks.applyFilters("moveAllowed",g,a,b)}}},bu:{lazy_load:e.lazyLoad}};e.showCounts&&(h.treeConfig.json_data.progressive_render=!1);e.initialTreeData&&(h.treeConfig.json_data.data=e.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",h.treeConfig,d);b.initialize=function(){d.jstree(h.treeConfig);return b};b.selectPost=
function(a,f){var f=f||!0,b=c.getNodeForPost(a);f&&d.jstree("deselect_all");d.jstree("select_node",b)};b.getSelectedPost=function(){var a=d.jstree("get_selected");return a.length?c.nodeToPost(a):!1};b.deselectAll=function(){d.jstree("deselect_all")};b.getPost=function(a){return(a=c.getNodeForPost(a))?c.nodeToPost(a):!1};b.getPosts=function(a){var f=[],q={},e,i;(a?g.jstree._reference(d)._get_node("#"+a):d).find("> ul > li").each(function(a,l){l=g(l);e=l.attr("id");i=l.data("post_type");"new"!=i&&(e=
c.stripNodePrefix(e));q={ID:e,type:i,status:l.data("post_status"),title:d.jstree("get_text",l),content:l.data("post_content"),meta:l.data("post_meta")};l.find("> ul > li").length&&(q.children=b.getPosts(l.attr("id")));f.push(q)});return f};b.showAll=function(){d.jstree("open_all")};b.hideAll=function(){d.jstree("close_all")};b.getPostLabel=function(a){a=c.getNodeForPost(a);return d.jstree("get_text",a)};b.setPostLabel=function(a,f){var b=c.getNodeForPost(a);d.jstree("set_text",b,f)};b.insertPost=
function(a){var f,g;if("undefined"===typeof a)throw new TypeError("Post argument for insertPost must be defined!");var e,i,l;a.parent=a.parent||0;a.menu_order=a.menu_order||1;a.parent?(f=c.getNodeForPost(a.parent),e=b.getPost(a.parent)):f=d;1==a.menu_order?(i=f.find("> ul > li").get(0),g="before"):(l=a.menu_order-2,0<=l&&(i=f.find("> ul > li").get(l),g="after"));i||(i=f,g="inside");f=i;a=bu.hooks.applyFilters("preInsertPost",a,e);e=c.postToNode(a);e=d.jstree("create",f,g,e,function(a){d.jstree("deselect_all");
d.jstree("select_node",a)},!0);a.ID||(a.ID=e.attr("id"));return a};b.updatePost=function(a){var f=c.getNodeForPost(a),q;return f?(q=c.nodeToPost(f),a=g.extend(!0,{},q,a),d.jstree("set_text",f,a.title),f.data("post_content",a.content),f.data("post_title",a.title),f.data("post_status",a.status),f.data("post_type",a.type),f.data("post_parent",parseInt(a.parent,10)),f.data("menu_order",parseInt(a.menu_order,10)),f.data("post_meta",a.meta),e.showStatuses&&f.find("li").andSelf().each(function(){i(g(this))}),
b.broadcast("postUpdated",[a]),a):!1};b.removePost=function(a){a&&"undefined"===typeof a?(a=d.jstree("get_selected"),c.nodeToPost(a)):a=c.getNodeForPost(a);d.jstree("remove",a)};b.getAncestors=function(a){a=c.getNodeForPost(a);return d.jstree("get_path",a)};b.save=function(){h.rollback=d.jstree("get_rollback")};b.restore=function(){"undefined"!==typeof h.rollback&&(h.rollback.d.ui.selected=g([]),g.jstree.rollback(h.rollback),h.rollback=d.jstree("get_rollback"))};b.lock=function(){d.jstree("lock")};
b.unlock=function(){d.jstree("unlock")};c.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var f=a.attr("id");-1===f.indexOf("post-new")&&(f=parseInt(c.stripNodePrefix(f),10));f={ID:f,title:d.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:a.index()+1,meta:a.data("post_meta")||{},url:a.data("url"),originalParent:parseInt(a.data("originalParent"),10),originalOrder:parseInt(a.data("originalOrder"),
10),originalExclude:a.data("originalExclude")};return bu.hooks.applyFilters("nodeToPost",f,a)};c.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var f,a=g.extend({},{title:"(no title)",content:"",status:"new",type:"page",parent:0,menu_order:1,meta:{},url:""},a);f=a.ID?e.nodePrefix+a.ID:"post-new-"+c.getNextPostID();return bu.hooks.applyFilters("postToNode",{attr:{id:f,rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,
post_parent:a.parent,menu_order:a.menu_order,post_meta:a.meta,url:a.url,originalParent:a.originalParent,originalOrder:a.originalOrder,originalExclude:a.originalExclude}},a)};c.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=e.nodePrefix+a);a=g.jstree._reference(d)._get_node("#"+a);return a.length?a:!1};c.getNextPostID=function(){return g('[id*="post-new-"]').length};c.stripNodePrefix=
function(a){return a.replace(e.nodePrefix,"")};var n=function(a,f){var b=a.find("li").length,c=a.children("a");0===c.children(".title-count").children(".count").length&&c.children(".title-count").append('<span class="count"></span>');c=c.find("> .title-count > .count").empty();b?c.text("("+b+")"):c.text("");f&&a.find("li").each(function(){n(g(this))})},i=function(a){var f=a.children("a");0===f.children(".post-statuses").length&&f.append('<span class="post-statuses"></span>');var a=c.nodeToPost(a),
b,d,g;d=a.meta.excluded||!1;g=a.meta.restricted||!1;f=f.children(".post-statuses").empty();b=[];"publish"!=a.status&&b.push({"class":a.status,label:a.status});d&&b.push({"class":"excluded",label:"not in nav"});g&&b.push({"class":"restricted",label:"restricted"});for(a=0;a<b.length;a+=1)f.append('<span class="post_status '+b[a]["class"]+'">'+b[a].label+"</span>")},l=function(a){0===a.children("ul").length?a.attr("rel","page"):a.attr("rel","section");e.showCounts&&(a=a.parent("ul").parent("div").attr("id")!=
d.attr("id")?a.parents("li:last"):a,n(a,!0))};d.bind("loaded.jstree",function(){var a=d.find("> ul > li:first-child"),a=18<=a.height()?a.height():32;d.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});d.bind("reselect.jstree",function(){b.broadcast("postsSelected")});d.bind("lazy_loaded.jstree",function(){b.broadcast("lazyLoadComplete")});d.bind("load_node.jstree",function(a,b){if(-1!==b.rslt.obj){var c=b.rslt.obj;e.showCounts&&n(c,!0)}});d.bind("clean_node.jstree",function(a,b){var c=
b.rslt.obj;c&&-1!==c&&c.each(function(a,b){var c=g(b);c.data("bu-nav-extras-added")||(e.showStatuses&&i(c),c.data("bu-nav-extras-added",!0))})});d.bind("before.jstree",function(a,b){var c;switch(b.func){case "select_node":case "hover_node":case "start_drag":if((c=b.inst._get_node(b.args[0]))&&c.hasClass("denied"))return!1}});d.bind("create_node.jstree",function(a,f){var d=c.nodeToPost(f.rslt.obj);b.broadcast("postCreated",[d])});d.bind("select_node.jstree",function(a,f){var d=c.nodeToPost(f.rslt.obj);
b.broadcast("postSelected",[d])});d.bind("create.jstree",function(a,f){var d=f.rslt.parent,g=f.rslt.position,e=c.nodeToPost(f.rslt.obj),i=null;-1!==d&&(i=c.nodeToPost(d),l(d));e.parent=i?i.ID:0;e.menu_order=g+1;b.broadcast("postInserted",[e])});d.bind("remove.jstree",function(a,f){var d=f.rslt.obj,e=c.nodeToPost(d),i=f.rslt.parent,h;-1!==i&&l(i);b.broadcast("postRemoved",[e]);d.find("li").each(function(){(h=c.nodeToPost(g(this)))&&b.broadcast("postRemoved",[h])})});d.bind("deselect_node.jstree",function(a,
d){var e=c.nodeToPost(d.rslt.obj);b.broadcast("postDeselected",[e])});d.bind("deselect_all.jstree",function(){b.broadcast("postsDeselected")});d.bind("move_node.jstree",function(a,f){f.rslt.o.each(function(a,e){var i=g(e),h=c.nodeToPost(i),j=f.rslt.np,k=f.rslt.op,i=i.index()+1,m=0,n=0,p=1;d.attr("id")!==j.attr("id")&&(l(j),m=parseInt(c.stripNodePrefix(j.attr("id")),10));d.attr("id")!==k.attr("id")&&!j.is("#"+k.attr("id"))&&(l(k),j=c.nodeToPost(k),n=j.ID);p=h.menu_order;h.parent=m;h.menu_order=i;b.updatePost(h);
b.broadcast("postMoved",[h,n,p])})});j=function(a){var b=g.contains(d[0],a.target),a=g.contains(g("#vakata-contextmenu")[0],a.target);!b&&!a&&d.jstree("deselect_all")};e.deselectOnDocumentClick&&g(document).bind("click",j);return b},navman:function(m,c){var b={},c=c||{},b=r.trees.base(m,c),e=b.$el,h=b.data,d=function(d){d=c.nodeToPost(d);b.broadcast("editPost",[d])},j=function(b){b=c.nodeToPost(b);b.url&&window.open(b.url)},p=function(d){d=c.nodeToPost(d);b.removePost(d)};h.treeConfig.plugins.push("contextmenu");
h.treeConfig.contextmenu={show_at_node:!1,items:function(b){var c=b.data("url"),a=b.data("post_type"),f={edit:{label:"Edit",action:d},view:{label:"View",action:j},remove:{label:"Move to Trash",action:p}};c||delete f.view;"link"===a&&(f.remove.label="Delete");return bu.hooks.applyFilters("navmanOptionsMenuItems",f,b)}};e.bind("loaded.jstree",function(){e.undelegate("a","contextmenu.jstree")});e.bind("clean_node.jstree",function(b,c){var a=c.rslt.obj;a&&-1!=a&&a.each(function(a,b){var c=g(b).children("a");
if(!c.children(".edit-options").length){var d=g('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),e=c.children(".post-statuses");e.length?e.before(d):c.append(d)}})});var k=null;e.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var b=g(this).offset(),c=g(this).height()+5,a=g(this).parent("a").parent("li");e.jstree("deselect_all");g(this).addClass("clicked");e.jstree("select_node",a);e.jstree("show_contextmenu",a,b.left,b.top+
c);k&&k.attr("id")!=a.attr("id")&&n(k);k=a});g(document).bind("context_hide.vakata",function(){n(k)});var n=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};e.addClass("bu-navman");return b},edit_post:function(m,c){var c=c||{},b=r.trees.base(m,c),e=b.data,h=g.extend(b.config,m||{}),d=b.$el,j=h.currentPost,p={},k=[],n;if(h.ancestors&&h.ancestors.length){var i=h.ancestors.reverse();for(n=0;n<i.length;n+=1)k.push("#"+h.nodePrefix+h.ancestors[n])}k.length&&(p.core={initially_open:k});
g.extend(!0,e.treeConfig,p);e=function(d,a){if(a.$el.is(b.$el.selector))return c.stripNodePrefix(d.attr("id"))==j.ID};bu.hooks.addFilter("canSelectNode",e);bu.hooks.addFilter("canHoverNode",e);bu.hooks.addFilter("canDragNode",e);d.bind("reselect.jstree",function(){c.getNodeForPost(j)||b.insertPost(j);0===d.jstree("get_selected").length&&(b.selectPost(j),b.save())});b.getCurrentPost=function(){var b;return(b=c.getNodeForPost(j))?b=c.nodeToPost(b):!1};b.setCurrentPost=function(b){j=b};b.scrollToSelection=
function(){var b=d.jstree("get_selected");if(b.length){g(document);d.css("overflow");var a=d.innerHeight(),b=b.position().top+b.height()/2-a/2;0<b&&d.scrollTop(b)}};d.addClass("bu-edit-post");return b}}})(jQuery);